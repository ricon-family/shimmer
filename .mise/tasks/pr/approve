#!/bin/bash
#MISE description="Approve a pull request (without merging)"
#USAGE arg "<number>" help="PR number"
#USAGE flag "--body <body>" help="Approval comment"
#USAGE flag "--repo <repo>" help="Repository (owner/repo) (default: current repo)"
set -eo pipefail

PR="${usage_number:-$1}"
BODY="${usage_body:-LGTM}"

if [[ -z "$PR" ]]; then
  echo "Usage: mise run pr:approve <number> [--body <message>] [--repo <owner/repo>]"
  exit 1
fi

# Determine repo: explicit flag > current directory
if [[ -n "${usage_repo:-}" ]]; then
  REPO="$usage_repo"
else
  TARGET_DIR="${PROJECT_DIR:-${SHIMMER_CALLER_PWD:-.}}"
  SCRIPT_DIR="$(dirname "$0")"
  REPO=$("$SCRIPT_DIR/../_get-repo-slug" "$TARGET_DIR")
fi

# Check PR state first
STATE=$(gh pr view "$PR" --repo "$REPO" --json state --jq '.state')
if [[ "$STATE" != "OPEN" ]]; then
  echo "PR #$PR is not open (state: $STATE)"
  exit 1
fi

gh pr review "$PR" --repo "$REPO" --approve --body "$BODY"

echo ""
echo "PR #$PR approved ($REPO)"
