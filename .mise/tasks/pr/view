#!/bin/bash
#MISE description="View pull request details"
#USAGE arg "<number>" help="PR number"
set -eo pipefail

PR="${usage_number:-$1}"
DIFF_THRESHOLD=100  # Include diff if under this many lines
COMMENT_THRESHOLD=10  # Include full issue if under this many comments

if [[ -z "$PR" ]]; then
  echo "Usage: mise run pr:view <number>"
  exit 1
fi

# Determine target directory and repo
TARGET_DIR="${PROJECT_DIR:-${SHIMMER_CALLER_PWD:-.}}"
SCRIPT_DIR="$(dirname "$0")"
REPO=$("$SCRIPT_DIR/../pm/_get-repo" "$TARGET_DIR")

# Get PR details as JSON for processing
PR_JSON=$(gh pr view "$PR" --repo "$REPO" --json title,author,state,createdAt,additions,deletions,reviewRequests,reviews,body,closingIssuesReferences)

TITLE=$(echo "$PR_JSON" | jq -r '.title')
AUTHOR=$(echo "$PR_JSON" | jq -r '.author.login')
STATE=$(echo "$PR_JSON" | jq -r '.state')
CREATED=$(echo "$PR_JSON" | jq -r '.createdAt | split("T")[0]')
ADDITIONS=$(echo "$PR_JSON" | jq -r '.additions')
DELETIONS=$(echo "$PR_JSON" | jq -r '.deletions')
TOTAL_CHANGES=$((ADDITIONS + DELETIONS))
BODY=$(echo "$PR_JSON" | jq -r '.body')

echo "=== PR #$PR ==="
echo ""
echo "$TITLE"
echo "Author: $AUTHOR"
echo "State: $STATE"
echo "Created: $CREATED"
echo "Changes: +$ADDITIONS -$DELETIONS"
echo ""

# Pending review requests
REVIEWERS=$(echo "$PR_JSON" | jq -r '.reviewRequests[]?.login // empty' | tr '\n' ' ')
[[ -n "$REVIEWERS" ]] && echo "Reviewers requested: $REVIEWERS"

# Reviews with full comments
REVIEW_COUNT=$(echo "$PR_JSON" | jq '.reviews | length')
if [[ $REVIEW_COUNT -gt 0 ]]; then
  echo ""
  echo "=== Reviews ==="
  echo "$PR_JSON" | jq -r '.reviews[] | "--- \(.author.login) (\(.state)) ---\n\(.body)\n"'
fi

# Linked issues with summary or full content
ISSUES=$(echo "$PR_JSON" | jq -r '.closingIssuesReferences[]?.number // empty')
if [[ -n "$ISSUES" ]]; then
  echo ""
  echo "=== Linked Issues ==="
  for ISSUE_NUM in $ISSUES; do
    ISSUE_JSON=$(gh issue view "$ISSUE_NUM" --repo "$REPO" --json title,body,comments,author,createdAt)
    ISSUE_TITLE=$(echo "$ISSUE_JSON" | jq -r '.title')
    ISSUE_AUTHOR=$(echo "$ISSUE_JSON" | jq -r '.author.login')
    COMMENT_COUNT=$(echo "$ISSUE_JSON" | jq '.comments | length')

    echo ""
    echo "--- Issue #$ISSUE_NUM: $ISSUE_TITLE ---"
    echo "Author: $ISSUE_AUTHOR | Comments: $COMMENT_COUNT"

    if [[ $COMMENT_COUNT -lt $COMMENT_THRESHOLD ]]; then
      # Show full issue body and comments
      echo ""
      echo "$ISSUE_JSON" | jq -r '.body'

      if [[ $COMMENT_COUNT -gt 0 ]]; then
        echo ""
        echo "Comments:"
        echo "$ISSUE_JSON" | jq -r '.comments[] | "[\(.author.login) - \(.createdAt | split("T")[0])]:\n\(.body)\n"'
      fi
    else
      # Show summary only
      LAST_COMMENTER=$(echo "$ISSUE_JSON" | jq -r '.comments[-1].author.login')
      LAST_DATE=$(echo "$ISSUE_JSON" | jq -r '.comments[-1].createdAt | split("T")[0]')
      echo "(Large discussion - last comment by $LAST_COMMENTER on $LAST_DATE)"
      echo "Run: mise run issue:view $ISSUE_NUM"
    fi
  done
else
  echo ""
  echo "Linked issues: none"
fi

echo ""
echo "=== PR Description ==="
echo "$BODY"

echo ""
echo "=== CI Status ==="
gh pr checks "$PR" --repo "$REPO" 2>/dev/null || echo "No checks found"

# Include diff for small PRs
if [[ $TOTAL_CHANGES -lt $DIFF_THRESHOLD ]]; then
  echo ""
  echo "=== Diff ($TOTAL_CHANGES lines) ==="
  gh pr diff "$PR" --repo "$REPO"
else
  echo ""
  echo "=== Diff ==="
  echo "(Large diff: $TOTAL_CHANGES lines)"
  echo "Run: gh pr diff $PR --repo $REPO"
fi
