#!/bin/bash
#MISE description="List open pull requests for review"
#USAGE flag "--all" help="Show all open PRs (default: prioritized for review)"
set -eo pipefail

# Determine target directory and repo
TARGET_DIR="${PROJECT_DIR:-${SHIMMER_CALLER_PWD:-.}}"
SCRIPT_DIR="$(dirname "$0")"
REPO=$("$SCRIPT_DIR/../pm/_get-repo" "$TARGET_DIR")

SHOW_ALL="${usage_all:-false}"
NOW=$(date +%s)

# Get open PRs with review info
PRS=$(gh pr list --repo "$REPO" --state open --json number,title,author,createdAt,updatedAt,reviewDecision,reviews,additions,deletions --jq '
  sort_by(.createdAt) | .[] | {
    number,
    title,
    author: .author.login,
    createdAt,
    updatedAt,
    additions,
    deletions,
    reviewDecision,
    reviewCount: (.reviews | length)
  }
')

if [[ -z "$PRS" ]]; then
  echo "No open PRs - $REPO"
  exit 0
fi

echo "Open PRs (oldest first) - $REPO:"
echo ""

echo "$PRS" | while read -r pr; do
  NUMBER=$(echo "$pr" | jq -r '.number')
  TITLE=$(echo "$pr" | jq -r '.title')
  ADDITIONS=$(echo "$pr" | jq -r '.additions')
  DELETIONS=$(echo "$pr" | jq -r '.deletions')
  REVIEW_DECISION=$(echo "$pr" | jq -r '.reviewDecision')
  REVIEW_COUNT=$(echo "$pr" | jq -r '.reviewCount')
  CREATED_AT=$(echo "$pr" | jq -r '.createdAt')
  UPDATED_AT=$(echo "$pr" | jq -r '.updatedAt')

  # Calculate days since created and last update
  CREATED_TS=$(date -j -f "%Y-%m-%dT%H:%M:%SZ" "$CREATED_AT" +%s 2>/dev/null || date -d "$CREATED_AT" +%s)
  UPDATED_TS=$(date -j -f "%Y-%m-%dT%H:%M:%SZ" "$UPDATED_AT" +%s 2>/dev/null || date -d "$UPDATED_AT" +%s)
  DAYS_OLD=$(( (NOW - CREATED_TS) / 86400 ))
  DAYS_STALE=$(( (NOW - UPDATED_TS) / 86400 ))

  # Format age
  if [[ $DAYS_OLD -eq 0 ]]; then
    AGE="today"
  elif [[ $DAYS_OLD -eq 1 ]]; then
    AGE="1d"
  else
    AGE="${DAYS_OLD}d"
  fi

  # Format staleness (days since last update)
  if [[ $DAYS_STALE -eq 0 ]]; then
    STALE=""
  elif [[ $DAYS_STALE -ge 3 ]]; then
    STALE=" (stale ${DAYS_STALE}d)"
  else
    STALE=""
  fi

  # Format review status
  if [[ "$REVIEW_DECISION" == "APPROVED" ]]; then
    STATUS="✓ approved"
  elif [[ "$REVIEW_DECISION" == "CHANGES_REQUESTED" ]]; then
    STATUS="⚠ changes"
  elif [[ $REVIEW_COUNT -gt 0 ]]; then
    STATUS="◐ reviewed"
  else
    STATUS="○ needs review"
  fi

  # Format changes
  CHANGES="+${ADDITIONS}/-${DELETIONS}"

  printf "  #%-4s  %-14s  %-12s  %4s  %s%s\n" "$NUMBER" "$STATUS" "$CHANGES" "$AGE" "$TITLE" "$STALE"
done

echo ""
TOTAL=$(echo "$PRS" | jq -s 'length')
NEEDS_REVIEW=$(echo "$PRS" | jq -s '[.[] | select(.reviewCount == 0)] | length')
echo "Total: $TOTAL ($NEEDS_REVIEW need review)"
