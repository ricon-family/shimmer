#!/bin/bash
#MISE description="Merge a pull request"
#USAGE arg "<number>" help="PR number"
#USAGE flag "--body <body>" help="Merge commit body"
set -eo pipefail

PR="${usage_number:-$1}"
BODY="${usage_body:-}"

if [[ -z "$PR" ]]; then
  echo "Usage: mise run pr:merge <number> [--body <message>]"
  exit 1
fi

# Determine target directory and repo
TARGET_DIR="${PROJECT_DIR:-${SHIMMER_CALLER_PWD:-.}}"
SCRIPT_DIR="$(dirname "$0")"
REPO=$("$SCRIPT_DIR/../pm/_get-repo" "$TARGET_DIR")

# Check PR state first
STATE=$(gh pr view "$PR" --repo "$REPO" --json state --jq '.state')
if [[ "$STATE" == "MERGED" ]]; then
  echo "PR #$PR is already merged ($REPO)"
  exit 0
fi

if [[ "$STATE" != "OPEN" ]]; then
  echo "PR #$PR is not open (state: $STATE)"
  exit 1
fi

# Merge with squash
if [[ -n "$BODY" ]]; then
  gh pr merge "$PR" --repo "$REPO" --squash --delete-branch --body "$BODY"
else
  gh pr merge "$PR" --repo "$REPO" --squash --delete-branch
fi

# Confirm merge
RESULT=$(gh pr view "$PR" --repo "$REPO" --json state,mergedAt --jq '"\(.state) at \(.mergedAt)"')
echo ""
echo "PR #$PR: $RESULT ($REPO)"
