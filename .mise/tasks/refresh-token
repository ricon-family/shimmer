#!/usr/bin/env bash
#MISE description="Refresh the Claude OAuth token in GitHub secrets"

set -e

REPO=$(gh repo view --json nameWithOwner -q .nameWithOwner)

echo "Getting new OAuth token from Claude..."
RAW_OUTPUT=$(claude setup-token 2>&1)

# Extract just the token (starts with sk-ant-)
TOKEN=$(echo "$RAW_OUTPUT" | grep -o 'sk-ant-[A-Za-z0-9_-]*')

if [ -z "$TOKEN" ]; then
  echo "Failed to extract token from output"
  exit 1
fi

echo "Updating CLAUDE_CODE_OAUTH_TOKEN secret on $REPO..."
gh secret set CLAUDE_CODE_OAUTH_TOKEN --body "$TOKEN"

echo "Done! Token updated."
