#!/usr/bin/env bash
#MISE description="Show elapsed and remaining time for current run"

set -e

# RUN_TIMEOUT must be set by the workflow
if [ -z "$RUN_TIMEOUT" ]; then
  echo "Not running in CI (RUN_TIMEOUT not set)"
  exit 0
fi

# If RUN_START_TIME not set, try to get it from GitHub API
if [ -z "$RUN_START_TIME" ]; then
  if [ -n "$GITHUB_RUN_ID" ] && [ -n "$GITHUB_REPOSITORY" ]; then
    # Fetch run start time from GitHub API (needs actions:read permission)
    run_started_at=$(gh api "repos/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" --jq '.run_started_at' 2>/dev/null || true)
    # Check if we got a valid timestamp (not an error message)
    if [[ "$run_started_at" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}T ]]; then
      RUN_START_TIME=$(date -d "$run_started_at" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$run_started_at" +%s 2>/dev/null)
    fi
  fi
fi

if [ -z "$RUN_START_TIME" ]; then
  echo "Not running in CI (RUN_START_TIME not available)"
  exit 0
fi

current_time=$(date +%s)
elapsed=$((current_time - RUN_START_TIME))
remaining=$((RUN_TIMEOUT - elapsed))

elapsed_min=$((elapsed / 60))
elapsed_sec=$((elapsed % 60))

printf "Elapsed: %d:%02d\n" $elapsed_min $elapsed_sec

if [ $remaining -lt 0 ]; then
  exceeded=$((-remaining))
  exceeded_min=$((exceeded / 60))
  exceeded_sec=$((exceeded % 60))
  printf "Remaining: 0:00 (exceeded by %d:%02d)\n" $exceeded_min $exceeded_sec
else
  remaining_min=$((remaining / 60))
  remaining_sec=$((remaining % 60))
  printf "Remaining: %d:%02d\n" $remaining_min $remaining_sec
fi

# Status message based on remaining time (mutually exclusive)
if [ $remaining -lt 0 ]; then
  echo "üö® EXCEEDED: Time limit has been exceeded!"
elif [ $remaining -lt 60 ]; then
  echo "üö® CRITICAL: Less than 1 minute remaining!"
elif [ $remaining -lt 120 ]; then
  echo "‚ö†Ô∏è  WARNING: Less than 2 minutes remaining - wrap up!"
fi
