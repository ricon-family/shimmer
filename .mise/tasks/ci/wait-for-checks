#!/usr/bin/env bash
#MISE description="Wait for PR checks to complete (timeout 3 min)"
#USAGE arg "[pr_number]" help="PR number (defaults to current branch PR)"

set -e

# Determine target directory and repo
TARGET_DIR="${PROJECT_DIR:-${SHIMMER_CALLER_PWD:-.}}"
SCRIPT_DIR="$(dirname "$0")"
REPO=$("$SCRIPT_DIR/../_get-repo-slug" "$TARGET_DIR")

PR_NUMBER="${usage_pr_number:-$(gh pr view --repo "$REPO" --json number -q .number 2>/dev/null)}"

if [ -z "$PR_NUMBER" ]; then
  echo "No PR number provided and not on a PR branch"
  exit 1
fi

echo "Waiting for checks on PR #$PR_NUMBER ($REPO) - timeout 3 min..."
if timeout 180 gh pr checks "$PR_NUMBER" --repo "$REPO" --watch; then
  echo "All checks passed!"
else
  EXIT_CODE=$?
  if [ $EXIT_CODE -eq 124 ]; then
    echo "Timed out waiting for checks"
  else
    echo "Checks failed (exit code: $EXIT_CODE)"
  fi
  exit 1
fi
