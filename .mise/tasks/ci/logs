#!/usr/bin/env bash
#MISE description="View logs from a workflow run with windowing support"
#USAGE arg "<run_id>" help="Run ID (numeric) or workflow name"
#USAGE flag "--offset <n>" help="Start at line N (default: 1)"
#USAGE flag "--limit <n>" help="Number of lines to show (default: 100)"
#USAGE flag "--tail" help="Show last N lines instead of offset-based window"
#USAGE flag "--no-cache" help="Force re-fetch of logs"
#USAGE flag "--info" help="Show log metadata (total lines, jobs) without content"
#USAGE flag "--agent" help="Show only the agent session (between markers)"
#USAGE flag "--repo <repo>" help="Repository (owner/name), defaults to current directory's repo"
#USAGE flag "--wait [timeout]" help="Wait for run to complete (default: 600s, supports 5m/1h/forever)"

set -e

# Determine repo - use --repo flag if provided, otherwise detect from directory
if [[ -n "${usage_repo:-}" ]]; then
  REPO="$usage_repo"
else
  TARGET_DIR="${PROJECT_DIR:-${SHIMMER_CALLER_PWD:-.}}"
  SCRIPT_DIR="$(dirname "$0")"
  REPO=$("$SCRIPT_DIR/../_get-repo-slug" "$TARGET_DIR")
fi

# Get values from mise usage variables
RUN_ID_ARG="${usage_run_id:-}"
OFFSET="${usage_offset:-1}"
LIMIT="${usage_limit:-100}"
TAIL_MODE="${usage_tail:-false}"
NO_CACHE="${usage_no_cache:-false}"
INFO_ONLY="${usage_info:-false}"
AGENT_ONLY="${usage_agent:-false}"

# Parse --wait flag
# Uses raw args check because mise doesn't set usage_wait for bare --wait
WAIT_TIMEOUT=""
if [[ -n "${usage_wait:-}" ]]; then
  WAIT_TIMEOUT="$usage_wait"
elif [[ " $* " == *" --wait "* ]] || [[ "$*" == "--wait" ]] || [[ "$*" == *" --wait" ]]; then
  WAIT_TIMEOUT="600"
fi

if [[ -z "$RUN_ID_ARG" ]]; then
  echo "Usage: ci:logs <run_id> [--repo owner/name] [--offset N] [--limit N] [--tail] [--info] [--agent]"
  exit 1
fi

# Detect if first arg is a run ID (numeric) or workflow name
if [[ "$RUN_ID_ARG" =~ ^[0-9]+$ ]]; then
  RUN_ID="$RUN_ID_ARG"
else
  WORKFLOW="$RUN_ID_ARG"
  RUN_ID=$(gh run list --repo "$REPO" --workflow="$WORKFLOW" --limit 1 --json databaseId -q '.[0].databaseId')
fi

# Cache directory
CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/shimmer/ci-logs"
mkdir -p "$CACHE_DIR"
CACHE_FILE="$CACHE_DIR/${REPO//\//_}_${RUN_ID}.log"

# Check run status
RUN_STATUS=$(gh run view "$RUN_ID" --repo "$REPO" --json status -q '.status')

# Fetch or use cached log (only use cache for completed runs)
if [[ -f "$CACHE_FILE" ]] && [[ "$NO_CACHE" != "true" ]] && [[ "$RUN_STATUS" == "completed" ]]; then
  LOG_SOURCE="(cached)"
else
  # Get the first non-skipped job (skipped jobs are common in multi-agent dispatch runs)
  JOB_INFO=$(gh run view "$RUN_ID" --repo "$REPO" --json jobs \
    -q '(([.jobs[] | select(.conclusion == "skipped" | not)][0]) // .jobs[0]) | {id: .databaseId, status: .status}')
  JOB_ID=$(echo "$JOB_INFO" | jq -r '.id')
  JOB_STATUS=$(echo "$JOB_INFO" | jq -r '.status')

  if [[ "$JOB_STATUS" == "in_progress" ]] || [[ "$JOB_STATUS" == "queued" ]] || [[ "$JOB_STATUS" == "waiting" ]]; then
    if [[ -z "$WAIT_TIMEOUT" ]]; then
      echo "job $JOB_ID is still $JOB_STATUS; logs will be available when it is complete"
      echo "Tip: use --wait to wait for completion"
      exit 1
    fi

    mise run ci:wait "$RUN_ID" --repo "$REPO" --timeout "$WAIT_TIMEOUT" > /dev/null
  fi

  gh run view --repo "$REPO" --job="$JOB_ID" --log 2>&1 > "$CACHE_FILE"
  LOG_SOURCE="(fetched)"
fi

TOTAL_LINES=$(wc -l < "$CACHE_FILE" | tr -d ' ')

# Info mode - just show metadata
if [[ "$INFO_ONLY" == "true" ]]; then
  echo "Run ID: $RUN_ID"
  echo "Repo: $REPO"
  echo "Total lines: $TOTAL_LINES"
  echo "Cache: $CACHE_FILE"
  exit 0
fi

# Agent mode - extract only the agent session between markers
if [[ "$AGENT_ONLY" == "true" ]]; then
  echo "=== $REPO run $RUN_ID $LOG_SOURCE - agent session ==="
  if grep -q "### AGENT SESSION START ###" "$CACHE_FILE"; then
    # Use awk to match only lines where the marker is the entire content (after prefix)
    awk '
      {
        content = $0
        sub(/^[^Z]*Z /, "", content)
        if (content == "### AGENT SESSION START ###") { capturing = 1; next }
        if (content == "### AGENT SESSION END ###") { capturing = 0; next }
        if (capturing) print content
      }
    ' "$CACHE_FILE"
  else
    echo "No agent session markers found in this run."
    echo "Markers are only present in runs after the template was updated."
    exit 1
  fi
  exit 0
fi

# Output header
if [[ "$TAIL_MODE" == "true" ]]; then
  echo "=== $REPO run $RUN_ID $LOG_SOURCE - last $LIMIT of $TOTAL_LINES lines ==="
  tail -n "$LIMIT" "$CACHE_FILE" | nl -ba -v $((TOTAL_LINES - LIMIT + 1))
else
  END_LINE=$((OFFSET + LIMIT - 1))
  echo "=== $REPO run $RUN_ID $LOG_SOURCE - lines $OFFSET-$END_LINE of $TOTAL_LINES ==="
  sed -n "${OFFSET},${END_LINE}p" "$CACHE_FILE" | nl -ba -v "$OFFSET"
fi
