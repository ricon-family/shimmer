#!/usr/bin/env bash
#MISE description="Trigger an agent workflow manually"
#MISE usage="trigger <agent> <job> [message]"

set -e

if [ $# -lt 2 ]; then
  echo "Usage: mise run trigger <agent> <job> [message]"
  echo ""
  echo "Agents: quick, brownie, junior, johnson, c0da"
  echo ""
  echo "Example jobs:"
  echo "  quick:   probe, discuss"
  echo "  brownie: critic, discuss, failure-analysis, runs-retro"
  echo "  junior:  cleanup, readme"
  echo "  johnson: discuss, pr-followup"
  echo "  c0da:    triage, activity-digest"
  echo ""
  echo "Example: mise run trigger quick probe"
  exit 1
fi

AGENT="$1"
JOB="$2"
MESSAGE="${3:-}"
REPO=$(gh repo view --json nameWithOwner -q .nameWithOwner)
WORKFLOW="${AGENT}-${JOB}.yml"

# Validate agent
case "$AGENT" in
  quick|brownie|junior|johnson|c0da) ;;
  *)
    echo "Unknown agent: $AGENT"
    echo "Available agents: quick, brownie, junior, johnson, c0da"
    exit 1
    ;;
esac

# Validate workflow exists
if [ ! -f ".github/workflows/$WORKFLOW" ]; then
  echo "Workflow not found: $WORKFLOW"
  echo ""
  echo "Available workflows for $AGENT:"
  ls .github/workflows/${AGENT}-*.yml 2>/dev/null | xargs -n1 basename | sed 's/^/  /' || echo "  (none)"
  exit 1
fi

if [ -n "$MESSAGE" ]; then
  gh workflow run "$WORKFLOW" -f message="$MESSAGE"
else
  gh workflow run "$WORKFLOW"
fi

echo "Triggered $WORKFLOW on $REPO"
echo "View at: https://github.com/$REPO/actions"
