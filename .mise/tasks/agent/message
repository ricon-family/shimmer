#!/usr/bin/env bash
#MISE description="Send a message to an agent (wakes them without a specific job)"
#USAGE arg "<agent>" help="Agent to message (e.g., quick, brownie)"
#USAGE arg "<message>" help="Message for the agent"
#USAGE flag "--model <model>" help="Claude model to use"

set -e

# Get the caller's directory (where shimmer was invoked from)
CALLER_DIR="${AGENT_HOME:-${SHIMMER_CALLER_PWD:-$(pwd)}}"

# Validate this is an agent home
validate_agent_home() {
  if [ ! -d "$CALLER_DIR/agents" ]; then
    echo "Error: No agents/ directory in $CALLER_DIR" >&2
    echo "Run this from an agent home (a codebase with agents/ and agent workflows)" >&2
    exit 1
  fi

  if [ ! -f "$CALLER_DIR/.github/workflows/agent-message.yml" ]; then
    echo "Error: No agent-message.yml workflow in $CALLER_DIR" >&2
    echo "Run this from an agent home (a codebase with agents/ and agent workflows)" >&2
    exit 1
  fi
}

# Discover agents from the caller's agents/ directory
get_agents() {
  ls "$CALLER_DIR/agents"/*.txt 2>/dev/null \
    | xargs -n1 basename \
    | sed 's/\.txt$//' \
    | sort
}

# Get the repo name from the caller's directory
get_repo() {
  git -C "$CALLER_DIR" remote get-url origin 2>/dev/null \
    | sed 's/.*github.com[:/]//' \
    | sed 's/\.git$//'
}

validate_agent_home

AGENT="$usage_agent"
MESSAGE="$usage_message"
MODEL="${usage_model:-}"
REPO=$(get_repo)
WORKFLOW="agent-message.yml"

# Validate agent
if ! get_agents | grep -qx "$AGENT"; then
  echo "Unknown agent: $AGENT"
  echo "Available agents: $(get_agents | tr '\n' ' ')"
  exit 1
fi

MODEL_ARG=""
if [ -n "$MODEL" ]; then
  MODEL_ARG="-f model=$MODEL"
fi

gh workflow run "$WORKFLOW" -R "$REPO" -f agent="$AGENT" -f message="$MESSAGE" $MODEL_ARG

# Wait briefly for GitHub to register the run, then get the URL and ID
sleep 2
RUN_INFO=$(gh run list -R "$REPO" --workflow="$WORKFLOW" --limit 1 --json url,databaseId 2>/dev/null)
RUN_URL=$(echo "$RUN_INFO" | jq -r '.[0].url // empty')
RUN_ID=$(echo "$RUN_INFO" | jq -r '.[0].databaseId // empty')

if [ -n "$RUN_ID" ]; then
  echo "✓ Sent to $AGENT (run $RUN_ID)"
  if [ -n "$RUN_URL" ]; then
    echo "  → $RUN_URL"
  fi
  echo "  → shimmer ci:logs $RUN_ID --agent --repo $REPO"
  echo ""
  echo "  Did you know? You can add --wait to ci:logs to wait for the agent to finish."
else
  echo "✓ Sent to $AGENT"
  echo "  → https://github.com/$REPO/actions/workflows/$WORKFLOW"
fi
