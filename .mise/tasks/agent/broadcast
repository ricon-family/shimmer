#!/usr/bin/env bash
#MISE description="Send a message to multiple agents"
#USAGE arg "<message>" help="Message for agents"
#USAGE flag "-s --stagger <seconds>" help="Seconds to wait between agents (default: 30)"
#USAGE flag "--agents <list>" help="Comma-separated list of agents (default: all)"
#USAGE flag "--dry-run" help="Show what would be done without triggering"
#USAGE flag "--model <model>" help="Claude model to use"

set -e

CALLER_DIR="${AGENT_HOME:-${SHIMMER_CALLER_PWD:-$(pwd)}}"

# Validate this is an agent home
if [ ! -d "$CALLER_DIR/agents" ]; then
  echo "Error: No agents/ directory in $CALLER_DIR" >&2
  echo "Run this from an agent home (a codebase with agents/ and agent workflows)" >&2
  exit 1
fi

if [ ! -f "$CALLER_DIR/.github/workflows/agent-message.yml" ]; then
  echo "Error: No agent-message.yml workflow in $CALLER_DIR" >&2
  echo "Run this from an agent home (a codebase with agents/ and agent workflows)" >&2
  exit 1
fi

MESSAGE="$usage_message"
STAGGER="${usage_stagger:-30}"
DRY_RUN="${usage_dry_run:-false}"
MODEL="${usage_model:-}"
AGENTS_FLAG="${usage_agents:-}"

# Discover or filter agents
ALL_AGENTS=$(ls "$CALLER_DIR/agents"/*.txt 2>/dev/null \
  | xargs -n1 basename \
  | sed 's/\.txt$//' \
  | sort)

if [ -n "$AGENTS_FLAG" ]; then
  # Filter to requested agents, validate each exists
  AGENTS=""
  for AGENT in $(echo "$AGENTS_FLAG" | tr ',' ' '); do
    if ! echo "$ALL_AGENTS" | grep -qx "$AGENT"; then
      echo "Unknown agent: $AGENT" >&2
      echo "Available agents: $(echo "$ALL_AGENTS" | tr '\n' ' ')" >&2
      exit 1
    fi
    AGENTS="${AGENTS:+$AGENTS$'\n'}$AGENT"
  done
else
  AGENTS="$ALL_AGENTS"
fi

AGENT_COUNT=$(echo "$AGENTS" | wc -l | tr -d ' ')

echo "Broadcasting to $AGENT_COUNT agents with ${STAGGER}s stagger"
echo "Message: $MESSAGE"
echo ""

MODEL_ARG=""
if [ -n "$MODEL" ]; then
  MODEL_ARG="--model $MODEL"
fi

FIRST=true
for AGENT in $AGENTS; do
  if [ "$FIRST" = true ]; then
    FIRST=false
  else
    if [ "$DRY_RUN" = "false" ]; then
      echo "Waiting ${STAGGER}s before next agent..."
      sleep "$STAGGER"
    fi
  fi

  if [ "$DRY_RUN" = "true" ]; then
    echo "[dry-run] Would message: $AGENT"
  else
    shimmer agent:message "$AGENT" "$MESSAGE" $MODEL_ARG
  fi
done

echo ""
if [ "$DRY_RUN" = "true" ]; then
  echo "Dry run complete. No agents were messaged."
else
  echo "Broadcast complete. All agents have been messaged."
fi
