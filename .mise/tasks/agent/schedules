#!/usr/bin/env bash
#MISE description="Show agent workflow schedules"

set -e

# Get the caller's directory (where shimmer was invoked from)
CALLER_DIR="${SHIMMER_CALLER_PWD:-$(pwd)}"
cd "$CALLER_DIR"

# Check for workflows.yaml
if [ ! -f "workflows.yaml" ]; then
  echo "No workflows.yaml found in $CALLER_DIR"
  exit 1
fi

# Fetch all workflow states upfront
REPO=$(git remote get-url origin 2>/dev/null | sed 's/.*github.com[:/]//' | sed 's/\.git$//')
workflow_data=$(gh api "repos/$REPO/actions/workflows" --jq '.workflows[] | "\(.path)\t\(.state)"' 2>/dev/null || true)

echo "Agent Schedules"
echo "==============="
echo ""
printf "%-8s %-12s %-10s %-24s %s\n" "STATUS" "NAME" "AGENT" "SCHEDULE" "MESSAGE"
printf "%-8s %-12s %-10s %-24s %s\n" "------" "----" "-----" "--------" "-------"

# Read workflows from yaml
WORKFLOW_COUNT=$(yq -r '.workflows | length' workflows.yaml 2>/dev/null || echo "0")

if [ "$WORKFLOW_COUNT" -eq 0 ]; then
  echo "(no scheduled workflows)"
  exit 0
fi

for i in $(seq 0 $((WORKFLOW_COUNT - 1))); do
  NAME=$(yq -r ".workflows[$i].name" workflows.yaml)
  AGENT=$(yq -r ".workflows[$i].agent" workflows.yaml)
  SCHEDULE=$(yq -r ".workflows[$i].schedule" workflows.yaml)
  MESSAGE=$(yq -r ".workflows[$i].message" workflows.yaml | head -1 | cut -c1-40)

  # Truncate message if too long
  if [ ${#MESSAGE} -ge 40 ]; then
    MESSAGE="${MESSAGE}..."
  fi

  # Get workflow state from cached data
  state=$(echo "$workflow_data" | grep "\.github/workflows/${NAME}.yml" | cut -f2)

  if [[ "$state" == "active" ]]; then
    status="✓"
  elif [[ "$state" == "disabled_manually" ]]; then
    status="✗"
  elif [[ -z "$state" ]]; then
    status="-"  # Workflow file doesn't exist yet
  else
    status="?"
  fi

  printf "%-8s %-12s %-10s %-24s %s\n" "$status" "$NAME" "$AGENT" "$SCHEDULE" "$MESSAGE"
done
