#!/usr/bin/env bash
#MISE description="Run an agent with a message"
#USAGE arg "<agent>" help="Agent to run (e.g., quick, brownie)"
#USAGE arg "<message>" help="Message for the agent"
#USAGE flag "--timeout <seconds>" default="540" help="Timeout in seconds"
#USAGE flag "--passphrase <phrase>" help="Admin override passphrase"
#USAGE flag "--system-prompt-file <file>" help="Path to system prompt file"
#USAGE flag "--job <job>" help="Job name (used to find job prompt)"
#USAGE flag "--model <model>" help="Claude model to use"

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SHIMMER_ROOT="$(cd "$SCRIPT_DIR/../../.." && pwd)"
CLI_DIR="$SHIMMER_ROOT/cli"

AGENT="${usage_agent}"
MESSAGE="${usage_message}"
TIMEOUT="${usage_timeout:-540}"
PASSPHRASE="${usage_passphrase:-}"
SYSTEM_PROMPT_FILE="${usage_system_prompt_file:-}"
JOB="${usage_job:-}"
MODEL="${usage_model:-}"

# Get the caller's directory (where shimmer was invoked from)
CALLER_DIR="${SHIMMER_CALLER_PWD:-$(pwd)}"

# Build system prompt if not provided
if [ -z "$SYSTEM_PROMPT_FILE" ]; then
  PROMPT_FILE=$(mktemp)

  # Add base prompt from shimmer
  if [ -f "$SHIMMER_ROOT/cli/priv/prompts/base.txt" ]; then
    cat "$SHIMMER_ROOT/cli/priv/prompts/base.txt" >> "$PROMPT_FILE"
  fi

  # Add agent identity (from caller's repo or shimmer)
  if [ -f "$CALLER_DIR/agents/$AGENT.txt" ]; then
    echo "" >> "$PROMPT_FILE"
    cat "$CALLER_DIR/agents/$AGENT.txt" >> "$PROMPT_FILE"
  elif [ -f "$SHIMMER_ROOT/agents/$AGENT.txt" ]; then
    echo "" >> "$PROMPT_FILE"
    cat "$SHIMMER_ROOT/agents/$AGENT.txt" >> "$PROMPT_FILE"
  else
    echo "Error: Agent identity not found for $AGENT" >&2
    exit 1
  fi

  # Add job prompt if specified
  if [ -n "$JOB" ]; then
    if [ -f "$CALLER_DIR/.jobs/$JOB.txt" ]; then
      echo "" >> "$PROMPT_FILE"
      echo "" >> "$PROMPT_FILE"
      cat "$CALLER_DIR/.jobs/$JOB.txt" >> "$PROMPT_FILE"
    elif [ -f "$SHIMMER_ROOT/.jobs/$JOB.txt" ]; then
      echo "" >> "$PROMPT_FILE"
      echo "" >> "$PROMPT_FILE"
      cat "$SHIMMER_ROOT/.jobs/$JOB.txt" >> "$PROMPT_FILE"
    else
      echo "Error: Job not found: $JOB" >&2
      exit 1
    fi
  fi

  SYSTEM_PROMPT_FILE="$PROMPT_FILE"
fi

# Build CLI arguments
CLI_ARGS=(
  --system-prompt-file "$SYSTEM_PROMPT_FILE"
  --agent "$AGENT"
  --timeout "$TIMEOUT"
)

if [ -n "$PASSPHRASE" ]; then
  CLI_ARGS+=(--passphrase "$PASSPHRASE")
fi

if [ -n "$MODEL" ]; then
  CLI_ARGS+=(--model "$MODEL")
fi

# Run the CLI
cd "$CLI_DIR"
exec mix shimmer "${CLI_ARGS[@]}" "$MESSAGE"
