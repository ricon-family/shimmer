#!/usr/bin/env bash
#MISE description="Refresh the Claude OAuth token in GitHub secrets"
#USAGE flag "--repo <repo>" help="Target repo (default: current directory's repo)"
# Note: This is also called automatically by `agent:sync-secrets` (unless --skip-oauth)

set -e

# Determine target repo
if [ -n "${usage_repo:-}" ]; then
  REPO="$usage_repo"
else
  TARGET_DIR="${PROJECT_DIR:-${SHIMMER_CALLER_PWD:-.}}"
  cd "$TARGET_DIR"
  REPO=$(gh repo view --json nameWithOwner -q .nameWithOwner)
fi

echo "Getting new OAuth token from Claude..."
# Use TERM=dumb to reduce (but not eliminate) escape sequences
RAW_OUTPUT=$(TERM=dumb claude setup-token 2>&1)

# Extract the token - handle escape codes and line wrapping
# 1. Strip carriage returns
# 2. Strip ANSI escape sequences
# 3. Strip newlines to join wrapped lines
# 4. Extract token (starts with sk-ant-oat01-, ends with AA)
TOKEN=$(echo "$RAW_OUTPUT" | \
  tr -d '\r' | \
  sed 's/\x1b\[[0-9;]*[a-zA-Z]//g' | \
  tr -d '\n' | \
  grep -o 'sk-ant-oat01-[A-Za-z0-9_-]*AA')

if [ -z "$TOKEN" ]; then
  echo "Failed to extract token from output"
  echo "--- Debug: cleaned output ---"
  echo "$RAW_OUTPUT" | tr -d '\r' | sed 's/\x1b\[[0-9;]*[a-zA-Z]//g' | tr -d '\n' | grep -o 'sk-ant-[A-Za-z0-9_-]*'
  echo "--- End debug ---"
  exit 1
fi

echo "Updating CLAUDE_CODE_OAUTH_TOKEN secret on $REPO..."
gh secret set CLAUDE_CODE_OAUTH_TOKEN --repo "$REPO" --body "$TOKEN"

echo "Done! Token updated (${#TOKEN} chars)."
