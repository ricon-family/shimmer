#!/usr/bin/env bash
#MISE description="Provision a new agent (GPG key, GitHub secrets, 1Password)"
#USAGE arg "<agent-name>" help="Name of the agent to provision"
#USAGE flag "--force" help="Regenerate existing GPG key"

set -e

AGENT="${usage_agent_name:?Usage: mise run agent:provision <agent-name> [--force]}"
FORCE="${usage_force:-}"
EMAIL="${AGENT}@ricon.family"
UPPER=$(echo "$AGENT" | tr '[:lower:]' '[:upper:]')
VAULT="Agents"

echo "=== Provisioning agent: $AGENT ==="
echo ""

# Check prerequisites
if ! gpg --list-keys admin@ricon.family >/dev/null 2>&1; then
  echo "ERROR: Org key (admin@ricon.family) not found in keyring."
  exit 1
fi

if ! command -v op &> /dev/null; then
  echo "ERROR: 1Password CLI (op) not found."
  exit 1
fi

if ! op account get &> /dev/null; then
  echo "ERROR: Not signed in to 1Password. Run: op signin"
  exit 1
fi

# === GPG Key ===
echo "--- GPG Key ---"
if gpg --list-keys "$EMAIL" >/dev/null 2>&1; then
  echo "[auto] Key for $EMAIL already exists"
  if [ "$FORCE" != "true" ]; then
    echo "       Use --force to regenerate"
  fi
else
  echo "[auto] Generating GPG key for $EMAIL..."
  gpg --batch --gen-key << KEYSPEC
Key-Type: RSA
Key-Length: 4096
Name-Real: $AGENT
Name-Email: $EMAIL
Expire-Date: 0
%no-protection
%commit
KEYSPEC
fi

# Sign with org key
FINGERPRINT=$(gpg --list-keys --keyid-format LONG "$EMAIL" | grep -A1 "^pub" | tail -1 | tr -d ' ')
echo "[auto] Signing with org key..."
gpg --batch --yes --no-tty --local-user admin@ricon.family --quick-sign-key "$FINGERPRINT" 2>&1 || true

# === GitHub Secrets ===
echo ""
echo "--- GitHub Secrets ---"
echo "[auto] Storing ${UPPER}_GPG_PRIVATE_KEY..."
gpg --armor --export-secret-keys "$EMAIL" | gh secret set "${UPPER}_GPG_PRIVATE_KEY"
echo "[auto] Storing ${UPPER}_GPG_PUBLIC_KEY..."
gpg --armor --export "$EMAIL" | gh secret set "${UPPER}_GPG_PUBLIC_KEY"

# === 1Password ===
echo ""
echo "--- 1Password ---"

KEY_ID=$(gpg --list-keys --keyid-format LONG "$EMAIL" | grep "^pub" | awk '{print $2}' | cut -d'/' -f2)
PRIVATE_KEY=$(gpg --armor --export-secret-keys "$EMAIL" 2>/dev/null)
PUBLIC_KEY=$(gpg --armor --export "$EMAIL" 2>/dev/null)

item_exists() {
  op item get "$1" --vault "$VAULT" &> /dev/null
}

# Email item
if item_exists "${AGENT} - Email"; then
  echo "[auto] ${AGENT} - Email already exists"
else
  echo "[auto] Creating ${AGENT} - Email..."
  op item create \
    --category login \
    --title "${AGENT} - Email" \
    --vault "$VAULT" \
    --url "https://mail.ricon.family" \
    username="$AGENT" \
    "email[text]=$EMAIL" \
    --generate-password=20,letters,digits > /dev/null
fi

# GPG item
if item_exists "${AGENT} - GPG"; then
  echo "[auto] ${AGENT} - GPG already exists"
else
  echo "[auto] Creating ${AGENT} - GPG..."
  op item create \
    --category "Secure Note" \
    --title "${AGENT} - GPG" \
    --vault "$VAULT" \
    "Key ID[text]=$KEY_ID" \
    "Fingerprint[text]=$FINGERPRINT" \
    "Email[text]=$EMAIL" \
    "Private Key[text]=$PRIVATE_KEY" \
    "Public Key[text]=$PUBLIC_KEY" \
    "GitHub Title[text]=$EMAIL" > /dev/null
fi

# GitHub item
if item_exists "${AGENT} - GitHub"; then
  echo "[auto] ${AGENT} - GitHub already exists"
else
  echo "[auto] Creating ${AGENT} - GitHub..."
  op item create \
    --category login \
    --title "${AGENT} - GitHub" \
    --vault "$VAULT" \
    --url "https://github.com" \
    username="${AGENT}-ricon" \
    "email[text]=$EMAIL" \
    "country[text]=United States of America" \
    --generate-password=20,letters,digits > /dev/null
fi

# Matrix item
if item_exists "${AGENT} - Matrix"; then
  echo "[auto] ${AGENT} - Matrix already exists"
else
  echo "[auto] Creating ${AGENT} - Matrix..."
  op item create \
    --category login \
    --title "${AGENT} - Matrix" \
    --vault "$VAULT" \
    --url "https://matrix.ricon.family" \
    username="@${AGENT}:ricon.family" \
    --generate-password=20,letters,digits > /dev/null
fi

echo ""
echo "=== $AGENT provisioned ==="
echo ""
echo "Next: mise run agent:onboard $AGENT"
