#!/usr/bin/env bash
#MISE description="Sync agent secrets from 1Password to GitHub"
#USAGE arg "[agent]" help="Agent to sync (omit for all agents)"
#USAGE flag "--dry-run" help="Show what would be synced without making changes"
#USAGE flag "--with-oauth" help="Also refresh the shared Claude OAuth token (interactive)"

set -e

# Determine target directory (caller's directory when using shimmer alias)
TARGET_DIR="${PROJECT_DIR:-${SHIMMER_CALLER_PWD:-.}}"
cd "$TARGET_DIR"

AGENT="${usage_agent:-}"
DRY_RUN="${usage_dry_run:-false}"
WITH_OAUTH="${usage_with_oauth:-false}"
VAULT="Agents"

# Discover agents from prompt files (check agents/ or shimmer's agents/)
get_agents() {
  if [ -d "agents" ]; then
    ls agents/*.txt 2>/dev/null \
      | xargs -n1 basename \
      | sed 's/\.txt$//' \
      | sort
  else
    # Fallback: hardcoded list
    echo -e "brownie\nc0da\njohnson\njunior\nk7r2\nquick\nrho\nx1f9"
  fi
}

sync_agent() {
  local agent="$1"
  local agent_upper=$(echo "$agent" | tr '[:lower:]' '[:upper:]')

  echo "=== Syncing $agent ==="

  # Email password
  EMAIL_PASSWORD=$(op item get "${agent} - Email" --vault "$VAULT" --fields password --reveal 2>/dev/null || echo "")
  if [ -n "$EMAIL_PASSWORD" ]; then
    if [ "$DRY_RUN" = "true" ]; then
      echo "  [dry-run] Would sync ${agent_upper}_EMAIL_PASSWORD"
    else
      echo "  Syncing ${agent_upper}_EMAIL_PASSWORD..."
      echo "$EMAIL_PASSWORD" | gh secret set "${agent_upper}_EMAIL_PASSWORD"
    fi
  else
    echo "  [skip] No email password found in 1Password"
  fi

  # GitHub PAT
  GITHUB_PAT=$(op item get "${agent} - GitHub" --vault "$VAULT" --fields PAT --reveal 2>/dev/null || echo "")
  if [ -n "$GITHUB_PAT" ]; then
    if [ "$DRY_RUN" = "true" ]; then
      echo "  [dry-run] Would sync ${agent_upper}_GITHUB_PAT"
    else
      echo "  Syncing ${agent_upper}_GITHUB_PAT..."
      echo "$GITHUB_PAT" | gh secret set "${agent_upper}_GITHUB_PAT"
    fi
  else
    echo "  [skip] No GitHub PAT found in 1Password"
  fi

  # GitHub password (for browser automation login)
  GITHUB_PASSWORD=$(op item get "${agent} - GitHub" --vault "$VAULT" --fields password --reveal 2>/dev/null || echo "")
  if [ -n "$GITHUB_PASSWORD" ]; then
    if [ "$DRY_RUN" = "true" ]; then
      echo "  [dry-run] Would sync ${agent_upper}_GITHUB_PASSWORD"
    else
      echo "  Syncing ${agent_upper}_GITHUB_PASSWORD..."
      echo "$GITHUB_PASSWORD" | gh secret set "${agent_upper}_GITHUB_PASSWORD"
    fi
  else
    echo "  [skip] No GitHub password found in 1Password"
  fi

  # Matrix password
  MATRIX_PASSWORD=$(op item get "${agent} - Matrix" --vault "$VAULT" --fields password --reveal 2>/dev/null || echo "")
  if [ -n "$MATRIX_PASSWORD" ]; then
    if [ "$DRY_RUN" = "true" ]; then
      echo "  [dry-run] Would sync ${agent_upper}_MATRIX_PASSWORD"
    else
      echo "  Syncing ${agent_upper}_MATRIX_PASSWORD..."
      echo "$MATRIX_PASSWORD" | gh secret set "${agent_upper}_MATRIX_PASSWORD"
    fi
  else
    echo "  [skip] No Matrix password found in 1Password"
  fi

  # Admin override passphrase
  PASSPHRASE=$(op item get "${agent} - Identity" --vault "$VAULT" --fields passphrase --reveal 2>/dev/null || echo "")
  if [ -n "$PASSPHRASE" ]; then
    if [ "$DRY_RUN" = "true" ]; then
      echo "  [dry-run] Would sync ${agent_upper}_PASSPHRASE"
    else
      echo "  Syncing ${agent_upper}_PASSPHRASE..."
      echo "$PASSPHRASE" | gh secret set "${agent_upper}_PASSPHRASE"
    fi
  else
    echo "  [skip] No passphrase found in 1Password (${agent} - Identity.passphrase)"
  fi

  # GPG private key (use --format json to avoid quotes around multiline values)
  GPG_PRIVATE_KEY=$(op item get "${agent} - GPG" --vault "$VAULT" --fields "Private Key" --reveal --format json 2>/dev/null | jq -r '.value' || echo "")
  if [ -n "$GPG_PRIVATE_KEY" ]; then
    if [ "$DRY_RUN" = "true" ]; then
      echo "  [dry-run] Would sync ${agent_upper}_GPG_PRIVATE_KEY"
    else
      echo "  Syncing ${agent_upper}_GPG_PRIVATE_KEY..."
      gh secret set "${agent_upper}_GPG_PRIVATE_KEY" --body "$GPG_PRIVATE_KEY"
    fi
  else
    echo "  [skip] No GPG private key found in 1Password (${agent} - GPG)"
  fi

  # GPG public key (use --format json to avoid quotes around multiline values)
  GPG_PUBLIC_KEY=$(op item get "${agent} - GPG" --vault "$VAULT" --fields "Public Key" --reveal --format json 2>/dev/null | jq -r '.value' || echo "")
  if [ -n "$GPG_PUBLIC_KEY" ]; then
    if [ "$DRY_RUN" = "true" ]; then
      echo "  [dry-run] Would sync ${agent_upper}_GPG_PUBLIC_KEY"
    else
      echo "  Syncing ${agent_upper}_GPG_PUBLIC_KEY..."
      gh secret set "${agent_upper}_GPG_PUBLIC_KEY" --body "$GPG_PUBLIC_KEY"
    fi
  else
    echo "  [skip] No GPG public key found in 1Password (${agent} - GPG)"
  fi

  echo ""
}

# Check prerequisites
if ! command -v op &> /dev/null; then
  echo "ERROR: 1Password CLI (op) not found."
  exit 1
fi

if ! op account get &> /dev/null; then
  echo "ERROR: Not signed in to 1Password. Run: op signin"
  exit 1
fi

echo "Syncing secrets from 1Password â†’ GitHub"
echo "Vault: $VAULT"
echo ""

if [ -n "$AGENT" ]; then
  # Single agent
  if ! get_agents | grep -qx "$AGENT"; then
    echo "Unknown agent: $AGENT"
    echo "Available agents: $(get_agents | tr '\n' ' ')"
    exit 1
  fi
  sync_agent "$AGENT"
else
  # All agents
  for agent in $(get_agents); do
    sync_agent "$agent"
  done
fi

# Sync shared Claude OAuth token (only if --with-oauth flag is set)
if [ "$WITH_OAUTH" = "true" ]; then
  echo "=== Syncing shared OAuth token ==="
  if [ "$DRY_RUN" = "true" ]; then
    echo "  [dry-run] Would refresh CLAUDE_CODE_OAUTH_TOKEN"
  else
    echo "  Refreshing CLAUDE_CODE_OAUTH_TOKEN (interactive)..."
    RAW_OUTPUT=$(claude setup-token 2>&1)
    TOKEN=$(echo "$RAW_OUTPUT" | grep -o 'sk-ant-[A-Za-z0-9_-]*')
    if [ -z "$TOKEN" ]; then
      echo "  [error] Failed to get OAuth token from Claude"
    else
      gh secret set CLAUDE_CODE_OAUTH_TOKEN --body "$TOKEN"
      echo "  Done"
    fi
  fi
  echo ""
fi

if [ "$DRY_RUN" = "true" ]; then
  echo "Dry run complete. No secrets were changed."
else
  echo "Sync complete!"
fi
