#!/usr/bin/env bash
#MISE description="Interactive onboarding for a new agent"
#USAGE arg "<agent-name>" help="Name of the agent to onboard"
#MISE raw=true

set -e

AGENT="${usage_agent_name:?Usage: mise run agent:onboard <agent-name>}"
AGENT_UPPER=$(echo "$AGENT" | tr '[:lower:]' '[:upper:]')
EMAIL="${AGENT}@ricon.family"
GITHUB_USERNAME="${AGENT}-ricon"
VAULT="Agents"

wait_for_enter() {
  echo ""
  read -r -p "Press Enter when done... "
  echo ""
}

# Check prerequisites
if ! command -v op &> /dev/null; then
  echo "ERROR: 1Password CLI (op) not found."
  exit 1
fi

if ! op account get &> /dev/null; then
  echo "ERROR: Not signed in to 1Password. Run: op signin"
  exit 1
fi

# Get credentials from 1Password
echo "Fetching credentials from 1Password..."
EMAIL_PASSWORD=$(op item get "${AGENT} - Email" --vault "$VAULT" --fields password --reveal 2>/dev/null || echo "")
GITHUB_PASSWORD=$(op item get "${AGENT} - GitHub" --vault "$VAULT" --fields password --reveal 2>/dev/null || echo "")
GITHUB_EMAIL=$(op item get "${AGENT} - GitHub" --vault "$VAULT" --fields email 2>/dev/null || echo "")
GITHUB_COUNTRY=$(op item get "${AGENT} - GitHub" --vault "$VAULT" --fields country 2>/dev/null || echo "")

if [ -z "$GITHUB_PASSWORD" ]; then
  echo "ERROR: Could not find ${AGENT} - GitHub in 1Password"
  echo "Run: mise run store-agent-credentials $AGENT"
  exit 1
fi

echo ""
echo "============================================================"
echo "  ONBOARDING: $AGENT"
echo "============================================================"

# STEP 1: Create Email Account
echo ""
echo "STEP 1: Create Email Account"
echo "------------------------------------------------------------"
echo "[YOU] Create mailbox at your mail provider:"
echo ""
echo "      Email:    $EMAIL"
echo "      Password: $EMAIL_PASSWORD"

wait_for_enter

echo "[auto] Storing email password as GitHub secret ${AGENT_UPPER}_EMAIL_PASSWORD..."
echo "$EMAIL_PASSWORD" | gh secret set "${AGENT_UPPER}_EMAIL_PASSWORD"
echo "[auto] Done!"

# Check if GitHub account already exists
GITHUB_USER_EXISTS=$(gh api "users/$GITHUB_USERNAME" 2>/dev/null && echo "yes" || echo "no")

if [ "$GITHUB_USER_EXISTS" = "yes" ]; then
  echo ""
  echo "STEP 2: Create GitHub Account"
  echo "------------------------------------------------------------"
  echo "[auto] $GITHUB_USERNAME already exists, skipping account creation"
  echo ""
  echo "STEP 3: GitHub Email Verification"
  echo "------------------------------------------------------------"
  echo "[auto] Skipping (account already exists)"
else
  # STEP 2: Create GitHub Account
  echo ""
  echo "STEP 2: Create GitHub Account"
  echo "------------------------------------------------------------"
  echo "[YOU] Go to: https://github.com/signup"
  echo ""
  echo "      Email:    $GITHUB_EMAIL"
  echo "      Password: $GITHUB_PASSWORD"
  echo "      Username: $GITHUB_USERNAME"
  echo "      Country:  $GITHUB_COUNTRY"

  wait_for_enter

  # STEP 3: GitHub Email Verification
  echo "STEP 3: GitHub Email Verification"
  echo "------------------------------------------------------------"
  echo "[auto] Checking for GitHub verification email..."

  mise run email:setup "$AGENT" > /dev/null 2>&1

  # Poll for GitHub verification email (up to 60 seconds)
  VERIFICATION_CODE=""
  for i in {1..12}; do
    # Get the most recent email from GitHub
    LATEST_ID=$(himalaya envelope list 2>/dev/null | grep -i "launch code" | head -1 | awk -F'|' '{print $2}' | tr -d ' ' || true)
    if [ -n "$LATEST_ID" ]; then
      # Read the email and extract the verification code (typically 6-8 digits)
      EMAIL_BODY=$(himalaya message read "$LATEST_ID" 2>/dev/null || true)
      VERIFICATION_CODE=$(echo "$EMAIL_BODY" | grep -oE '[0-9]{6,8}' | head -1 || true)
      if [ -n "$VERIFICATION_CODE" ]; then
        break
      fi
    fi
    echo "       Checking... ($i/12)"
    sleep 5
  done

  if [ -n "$VERIFICATION_CODE" ]; then
    echo ""
    echo "[YOU] Enter this code on the GitHub signup page: $VERIFICATION_CODE"
    echo ""
    echo "      If prompted to log in:"
    echo "        Email:    $GITHUB_EMAIL"
    echo "        Password: $GITHUB_PASSWORD"
  else
    echo ""
    echo "[auto] Could not find verification code automatically."
    echo "[YOU] Check manually: himalaya envelope list && himalaya message read <ID>"
  fi

  wait_for_enter
fi

# STEP 4: Organization Setup
echo "STEP 4: Organization Setup"
echo "------------------------------------------------------------"

MEMBERSHIP=$(gh api "orgs/ricon-family/memberships/$GITHUB_USERNAME" 2>&1 || true)

if echo "$MEMBERSHIP" | grep -q '"state":"active"'; then
  echo "[auto] $GITHUB_USERNAME is already an active org member"
else
  echo "[auto] Inviting $GITHUB_USERNAME to ricon-family org..."
  gh api --method PUT "orgs/ricon-family/memberships/$GITHUB_USERNAME" -f role=member > /dev/null 2>&1 || true
fi

echo "[auto] Adding to agents team (grants write access)..."
gh api --method PUT "orgs/ricon-family/teams/agents/memberships/$GITHUB_USERNAME" -f role=member > /dev/null 2>&1 || true

echo ""
echo "[YOU] Accept the org invitation as $GITHUB_USERNAME:"
echo "      https://github.com/orgs/ricon-family/invitation"

wait_for_enter

# STEP 5: Upload GPG Key
echo "STEP 5: Upload GPG Key"
echo "------------------------------------------------------------"
echo "[YOU] As $GITHUB_USERNAME, go to: https://github.com/settings/keys"
echo "      Click: New GPG key"
echo "      Title: $EMAIL"
echo "      Key:"
echo ""
op item get "${AGENT} - GPG" --vault "$VAULT" --fields "Public Key" 2>/dev/null
echo ""

wait_for_enter

# STEP 6: Create Personal Access Token
echo "STEP 6: Create Personal Access Token"
echo "------------------------------------------------------------"
echo "[auto] Opening browser to create full-access personal token..."
echo ""

# Run github:token:new-personal (shows credentials, opens incognito browser)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
"$SCRIPT_DIR/../github/token/new-personal" "$AGENT"

wait_for_enter

# STEP 7: Store PAT
echo "STEP 7: Store PAT"
echo "------------------------------------------------------------"
echo ""
read -r -p "Paste the PAT token: " PAT_TOKEN
echo ""

if [ -n "$PAT_TOKEN" ]; then
  echo "[auto] Storing in 1Password..."
  op item edit "$AGENT - GitHub" --vault Agents "PAT[password]=$PAT_TOKEN" > /dev/null 2>&1 || true

  echo "[auto] Storing as GitHub secret ${AGENT_UPPER}_GITHUB_PAT..."
  echo "$PAT_TOKEN" | gh secret set "${AGENT_UPPER}_GITHUB_PAT"

  echo "[auto] Done!"
else
  echo "[WARN] No token provided, skipping storage"
fi

wait_for_enter

# STEP 8: Matrix Setup
echo "STEP 8: Matrix Setup"
echo "------------------------------------------------------------"

MATRIX_PASSWORD=$(op item get "${AGENT} - Matrix" --vault "$VAULT" --fields password --reveal 2>/dev/null || echo "")
MATRIX_USER="@${AGENT}:ricon.family"

if [ -z "$MATRIX_PASSWORD" ]; then
  echo "[WARN] No Matrix password found in 1Password, skipping Matrix setup"
  echo "       Run: mise run agent:provision $AGENT to create Matrix credentials"
else
  echo "[YOU] Create Matrix user via Synapse Admin:"
  echo "      User:     $MATRIX_USER"
  echo "      Password: $MATRIX_PASSWORD"
  echo ""

  wait_for_enter

  echo "[auto] Storing password as GitHub secret ${AGENT_UPPER}_MATRIX_PASSWORD..."
  echo "$MATRIX_PASSWORD" | gh secret set "${AGENT_UPPER}_MATRIX_PASSWORD"
  echo "[auto] Done! Agent will log in with password during workflow runs."
fi

wait_for_enter

# STEP 9: Verify
echo "STEP 9: Verify Setup"
echo "------------------------------------------------------------"
echo "[auto] Triggering test workflow..."

if ! gh workflow run test-agent-identity.yml -f agent="$AGENT" 2>&1; then
  echo ""
  echo "[WARN] Failed to trigger test workflow. You may need to trigger it manually:"
  echo "       gh workflow run test-agent-identity.yml -f agent=$AGENT"
  echo ""
fi
sleep 2

# Get the run URL
RUN_URL=$(gh run list --workflow=test-agent-identity.yml --limit=1 --json url --jq '.[0].url' 2>/dev/null || true)

if [ -n "$RUN_URL" ]; then
  echo ""
  echo "[YOU] Review the workflow run:"
  echo "      $RUN_URL"
  echo ""
  echo "      Wait for it to complete, then check:"
  echo "      - Commit was created and signed"
  echo "      - Signature shows 'Good signature from $EMAIL'"
else
  echo ""
  echo "[auto] Could not get run URL. Check manually:"
  echo "      https://github.com/ricon-family/shimmer/actions/workflows/test-agent-identity.yml"
fi

wait_for_enter

echo "============================================================"
echo "  DONE! $AGENT is fully onboarded."
echo "============================================================"
