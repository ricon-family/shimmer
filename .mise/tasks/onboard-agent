#!/usr/bin/env bash
#MISE description="Generate onboarding instructions for a new agent"
#MISE usage="onboard-agent <agent-name>"

set -e

AGENT="${1:?Usage: mise run onboard-agent <agent-name>}"
AGENT_UPPER=$(echo "$AGENT" | tr '[:lower:]' '[:upper:]')
EMAIL="${AGENT}@ricon.family"
GITHUB_USERNAME="${AGENT}-ricon"
VAULT="Agents"

# Check prerequisites
if ! command -v op &> /dev/null; then
  echo "ERROR: 1Password CLI (op) not found."
  exit 1
fi

if ! op account get &> /dev/null; then
  echo "ERROR: Not signed in to 1Password. Run: op signin"
  exit 1
fi

# Get credentials from 1Password
echo "Fetching credentials from 1Password..."
GITHUB_PASSWORD=$(op item get "${AGENT} - GitHub" --vault "$VAULT" --fields password --reveal 2>/dev/null || echo "")
GITHUB_EMAIL=$(op item get "${AGENT} - GitHub" --vault "$VAULT" --fields email 2>/dev/null || echo "")
GITHUB_COUNTRY=$(op item get "${AGENT} - GitHub" --vault "$VAULT" --fields country 2>/dev/null || echo "")
EMAIL_PASSWORD=$(op item get "${AGENT} - Email" --vault "$VAULT" --fields password --reveal 2>/dev/null || echo "")

if [ -z "$GITHUB_PASSWORD" ]; then
  echo "ERROR: Could not find ${AGENT} - GitHub in 1Password"
  echo "Run: mise run store-agent-credentials $AGENT"
  exit 1
fi

echo ""
echo "============================================================"
echo "  ONBOARDING: $AGENT"
echo "============================================================"
echo ""
echo "STEP 1: Create GitHub Account"
echo "------------------------------------------------------------"
echo "Go to: https://github.com/signup"
echo ""
echo "  Email:    $GITHUB_EMAIL"
echo "  Password: $GITHUB_PASSWORD"
echo "  Username: $GITHUB_USERNAME"
echo "  Country:  $GITHUB_COUNTRY"
echo ""
echo "When done, run: mise run onboard-agent-step2 $AGENT"
