#!/usr/bin/env bash
#MISE description="Show work in progress (open PRs and issues with discussion status)"
# Usage: mise run wip [limit]
# limit: Max items to show (default: 20)

set -e

export GH_PAGER=""

# Get repo dynamically
REPO=$(gh repo view --json nameWithOwner -q .nameWithOwner)
OWNER="${REPO%/*}"
NAME="${REPO#*/}"

# Accept optional limit argument
LIMIT="${1:-20}"

echo "=== Open Issues ==="
gh api graphql -f query="
query {
  repository(owner: \"$OWNER\", name: \"$NAME\") {
    issues(first: $LIMIT, states: OPEN, orderBy: {field: CREATED_AT, direction: ASC}) {
      nodes {
        number
        title
        comments(last: 1) {
          totalCount
          nodes {
            author { login }
            createdAt
          }
        }
      }
    }
  }
}" --jq '.data.repository.issues.nodes[] |
  "#\(.number)  \(.title[0:35])\(if (.title | length) > 35 then "..." else "" end)  \(.comments.totalCount) comments\(
    if .comments.totalCount > 0 then
      " (last: \(.comments.nodes[0].author.login), \(
        (now - (.comments.nodes[0].createdAt | fromdateiso8601)) / 3600 | floor
      )h ago)"
    else "" end
  )"'

echo ""
echo "=== Open PRs ==="
gh api graphql -f query="
query {
  repository(owner: \"$OWNER\", name: \"$NAME\") {
    pullRequests(first: $LIMIT, states: OPEN, orderBy: {field: CREATED_AT, direction: ASC}) {
      nodes {
        number
        title
        comments(last: 1) {
          totalCount
          nodes {
            author { login }
            createdAt
          }
        }
      }
    }
  }
}" --jq '.data.repository.pullRequests.nodes[] |
  "#\(.number)  \(.title[0:35])\(if (.title | length) > 35 then "..." else "" end)  \(.comments.totalCount) comments\(
    if .comments.totalCount > 0 then
      " (last: \(.comments.nodes[0].author.login), \(
        (now - (.comments.nodes[0].createdAt | fromdateiso8601)) / 3600 | floor
      )h ago)"
    else "" end
  )"'
