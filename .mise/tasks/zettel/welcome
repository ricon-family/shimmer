#!/usr/bin/env bash
#MISE description="Zettelkasten status and recent activity"

set -e

# Determine current agent from environment or git config
if [ -n "$GIT_AUTHOR_EMAIL" ]; then
  AGENT=$(echo "$GIT_AUTHOR_EMAIL" | sed 's/@ricon\.family$//')
elif git config user.email 2>/dev/null | grep -q '@ricon.family'; then
  AGENT=$(git config user.email | sed 's/@ricon\.family$//')
else
  AGENT=""
fi

# Get shimmer repo location
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SHIMMER_DIR="$(cd "$SCRIPT_DIR/../../.." && pwd)"

if [ -z "$AGENT" ]; then
  echo ""
  echo "Zettelkasten"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ""
  echo "  No agent identity detected."
  echo "  Run: eval \$(shimmer as <agent>)"
  echo ""
  exit 0
fi

ZETTEL_DIR="$HOME/agents/$AGENT/zettelkasten"
export ZETTEL_ROOT="$ZETTEL_DIR"

# Check if it exists
if [ ! -d "$ZETTEL_DIR" ]; then
  echo ""
  echo "Zettelkasten"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ""
  echo "  No zettelkasten found at: $ZETTEL_DIR"
  echo ""
  echo "  A zettelkasten is your external memory - it persists across"
  echo "  sessions so you can build on previous experience."
  echo ""
  echo "  To create one:"
  echo "    mkdir -p $ZETTEL_DIR"
  echo "    cd $ZETTEL_DIR && git init"
  echo "    echo '# README' > README.md"
  echo ""
  echo "  Then explore your world and document what you find."
  echo "  Full guide: $SHIMMER_DIR/docs/agent-zettelkasten.md"
  echo ""
  exit 0
fi

cd "$ZETTEL_DIR"

# Check for README.md entry point
HAS_README=false
if [ -f "$ZETTEL_DIR/README.md" ]; then
  HAS_README=true
fi

# Portable stat wrapper - returns epoch time and filepath
# Usage: portable_stat <file>
# Output: epoch_time filepath
portable_stat() {
  if stat -c "%Y %n" "$1" 2>/dev/null; then
    return 0
  elif stat -f "%m %N" "$1" 2>/dev/null; then
    return 0
  fi
  return 1
}

echo ""
echo "Zettelkasten"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Path and entry point at top
echo "  Path:      $ZETTEL_DIR"
if [ "$HAS_README" = true ]; then
  echo "  README.md: ✓"
else
  echo "  README.md: ✗"
fi
echo ""

# Last active (prefer git, fall back to file mtime)
LAST_ACTIVE=""
if [ -d "$ZETTEL_DIR/.git" ]; then
  LAST_ACTIVE=$(git log -1 --format="%ar" 2>/dev/null || echo "")
fi
if [ -z "$LAST_ACTIVE" ]; then
  # Fall back to most recent file - try to get mtime portably
  NEWEST_FILE=$(find "$ZETTEL_DIR" -name "*.md" -type f -print0 2>/dev/null | xargs -0 ls -t 2>/dev/null | head -1)
  if [ -n "$NEWEST_FILE" ]; then
    MTIME=$(portable_stat "$NEWEST_FILE" 2>/dev/null | awk '{print $1}')
    if [ -n "$MTIME" ]; then
      NOW=$(date +%s)
      DIFF=$((NOW - MTIME))
      if [ $DIFF -lt 3600 ]; then
        LAST_ACTIVE="$((DIFF / 60)) minutes ago"
      elif [ $DIFF -lt 86400 ]; then
        LAST_ACTIVE="$((DIFF / 3600)) hours ago"
      else
        LAST_ACTIVE="$((DIFF / 86400)) days ago"
      fi
    fi
  fi
fi
if [ -n "$LAST_ACTIVE" ]; then
  echo "  Last active: $LAST_ACTIVE"
else
  echo "  Last active: unknown"
fi
echo ""

# Recent activity with dates (across all subdirs)
# Use ls -t for sorting by modification time (portable)
echo "  Recent activity:"
find "$ZETTEL_DIR" -name "*.md" -type f -print0 2>/dev/null | \
  xargs -0 ls -t 2>/dev/null | head -7 | while read -r filepath; do
    # Get file's last commit date if in git, otherwise use mtime
    if [ -d "$ZETTEL_DIR/.git" ]; then
      DATE=$(git log -1 --format="%as" -- "$filepath" 2>/dev/null)
    fi
    if [ -z "$DATE" ]; then
      MTIME=$(portable_stat "$filepath" 2>/dev/null | awk '{print $1}')
      if [ -n "$MTIME" ]; then
        DATE=$(date -r "$MTIME" "+%Y-%m-%d" 2>/dev/null || date -d "@$MTIME" "+%Y-%m-%d" 2>/dev/null)
      fi
    fi
    RELPATH="${filepath#$ZETTEL_DIR/}"
    if [ -n "$DATE" ]; then
      echo "    $DATE  $RELPATH"
    else
      echo "    ?           $RELPATH"
    fi
  done
echo ""

# Structure - show expected directories with counts
# Gather counts first
NOTES_DIR=""
NOTES_COUNT=0
for dir in notes 10_Zettelkasten; do
  if [ -d "$ZETTEL_DIR/$dir" ]; then
    NOTES_DIR="$dir"
    NOTES_COUNT=$(find "$ZETTEL_DIR/$dir" -maxdepth 1 -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
    break
  fi
done

SESSIONS_DIR=""
SESSIONS_COUNT=0
if [ -d "$ZETTEL_DIR/sessions" ]; then
  SESSIONS_DIR="sessions"
  SESSIONS_COUNT=$(find "$ZETTEL_DIR/sessions" -maxdepth 1 -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
fi

INBOX_DIR=""
INBOX_COUNT=0
for dir in inbox 00_Inbox; do
  if [ -d "$ZETTEL_DIR/$dir" ]; then
    INBOX_DIR="$dir"
    INBOX_COUNT=$(find "$ZETTEL_DIR/$dir" -maxdepth 1 -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
    break
  fi
done

# Structure - always show to teach the convention
echo "  Structure:"

# Inbox first - encourages processing pending items
if [ -n "$INBOX_DIR" ]; then
  printf "    %-12s → %s/\n" "$INBOX_COUNT pending" "$INBOX_DIR"
else
  printf "    %-12s → %s/\n" "0 pending" "inbox"
fi

# Sessions (more likely to be reviewed than notes)
if [ -n "$SESSIONS_DIR" ]; then
  printf "    %-12s → %s/\n" "$SESSIONS_COUNT sessions" "$SESSIONS_DIR"
else
  printf "    %-12s → %s/\n" "0 sessions" "sessions"
fi

# Notes (permanent atomic notes)
if [ -n "$NOTES_DIR" ]; then
  printf "    %-12s → %s/\n" "$NOTES_COUNT notes" "$NOTES_DIR"
else
  printf "    %-12s → %s/\n" "0 notes" "notes"
fi

# Uncategorized (files not in standard dirs, excluding README.md)
TOTAL_COUNT=$(find "$ZETTEL_DIR" -name "*.md" -type f 2>/dev/null | wc -l | tr -d ' ')
CATEGORIZED=$((NOTES_COUNT + SESSIONS_COUNT + INBOX_COUNT))
[ "$HAS_README" = true ] && CATEGORIZED=$((CATEGORIZED + 1))
UNCATEGORIZED=$((TOTAL_COUNT - CATEGORIZED))
if [ "$UNCATEGORIZED" -gt 0 ]; then
  printf "    %-12s %s\n" "$UNCATEGORIZED other" "(in root or other dirs)"
fi

echo ""

# Git status (brief) - only show if there's something notable
if [ -d "$ZETTEL_DIR/.git" ]; then
  if ! git diff --quiet 2>/dev/null || ! git diff --cached --quiet 2>/dev/null; then
    echo "  Git: uncommitted changes"
    echo ""
  fi
fi

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "  shimmer zettel:search <query>"
echo ""
