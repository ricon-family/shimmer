#!/usr/bin/env bash
#MISE description="Welcome message and status check for agents"

set -e

# Determine current agent from environment or git config
if [ -n "$GIT_AUTHOR_EMAIL" ]; then
  AGENT=$(echo "$GIT_AUTHOR_EMAIL" | sed 's/@ricon\.family$//')
elif git config user.email 2>/dev/null | grep -q '@ricon.family'; then
  AGENT=$(git config user.email | sed 's/@ricon\.family$//')
else
  AGENT=""
fi

# Get shimmer repo location (tasks are in .mise/tasks/)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SHIMMER_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"

echo ""
if [ -n "$AGENT" ]; then
  echo "Welcome, $AGENT!"
else
  echo "Welcome!"
  echo ""
  echo "  No agent identity detected."
  echo "  Run: eval \$(shimmer as <agent>)"
fi

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Shimmer commands (work from anywhere):"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "  shimmer whoami              Verify your identity"
echo "  shimmer pm:list-issues      Find work in the shimmer project"
echo "  shimmer ci:time-remaining   Check remaining time in CI runs"
echo ""
echo "  shimmer email:list          Check your email inbox"
echo "  shimmer matrix:tail <you>   See recent Matrix messages"
echo ""
echo "  shimmer code:welcome        Info about current codebase"
echo "  shimmer code:init:welcome   How to start new projects"
echo ""
echo "  shimmer tasks               List all available tasks"
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Health check:"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Helper for consistent formatting
# Usage: print_status "Label" "✓|✗" "status text" ["hint"]
print_status() {
  local label="$1"
  local check="$2"
  local status="$3"
  local hint="${4:-}"

  if [ -n "$hint" ]; then
    printf "  %-9s %s %-22s %s\n" "$label:" "$check" "$status" "→ $hint"
  else
    printf "  %-9s %s %s\n" "$label:" "$check" "$status"
  fi
}

# Identity check (env var or git config)
if [ -n "$GIT_AUTHOR_EMAIL" ] && echo "$GIT_AUTHOR_EMAIL" | grep -q '@ricon.family'; then
  print_status "Identity" "✓" "$GIT_AUTHOR_EMAIL"
elif git config user.email 2>/dev/null | grep -q '@ricon.family'; then
  print_status "Identity" "✓" "$(git config user.email)"
else
  print_status "Identity" "✗" "not set (run: eval \$(shimmer as <agent>))"
fi

# GPG check (only if we know the agent)
if [ -n "$AGENT" ]; then
  EMAIL="${AGENT}@ricon.family"

  if gpg --list-secret-keys "$EMAIL" &>/dev/null; then
    KEY_ID=$(gpg --list-secret-keys --keyid-format LONG "$EMAIL" 2>/dev/null | grep sec | head -1 | awk '{print $2}' | cut -d'/' -f2)
    SIGNING_KEY=$(git config --global user.signingkey 2>/dev/null || echo "")
    GPG_SIGN=$(git config --global commit.gpgsign 2>/dev/null || echo "false")

    if [ "$SIGNING_KEY" = "$KEY_ID" ] && [ "$GPG_SIGN" = "true" ]; then
      print_status "GPG" "✓" "signing enabled" "shimmer gpg:status $AGENT"
    elif [ "$GPG_SIGN" = "true" ]; then
      print_status "GPG" "✗" "wrong key configured" "shimmer gpg:setup $AGENT"
    else
      print_status "GPG" "✗" "signing disabled" "shimmer gpg:setup $AGENT"
    fi
  else
    print_status "GPG" "✗" "no key" "shimmer gpg:setup $AGENT"
  fi

  # Email check
  CONFIG_FILE="${HOME}/.config/himalaya/config.toml"
  if [ -f "$CONFIG_FILE" ] && grep -q "accounts.$AGENT" "$CONFIG_FILE" 2>/dev/null; then
    # Get quota and unread count (run from shimmer dir to find tasks)
    QUOTA_OUTPUT=$(cd "$SHIMMER_DIR" && mise run -q email:quota 2>/dev/null || echo "")
    QUOTA_PERCENT=$(echo "$QUOTA_OUTPUT" | grep -oE '[0-9]+%' | tr -d '%')
    UNREAD_COUNT=$(cd "$SHIMMER_DIR" && mise run -q email:list --unread --count 2>/dev/null || echo "0")

    # Build status string
    if [ -n "$UNREAD_COUNT" ] && [ "$UNREAD_COUNT" -gt 0 ]; then
      STATUS_TEXT="${UNREAD_COUNT} unread"
    else
      STATUS_TEXT="0 unread"
    fi
    if [ -n "$QUOTA_PERCENT" ]; then
      STATUS_TEXT="${STATUS_TEXT} (quota ${QUOTA_PERCENT}%)"
    fi

    # Determine check mark based on quota
    if [ -n "$QUOTA_PERCENT" ] && [ "$QUOTA_PERCENT" -ge 95 ]; then
      print_status "Email" "✗" "$STATUS_TEXT" "shimmer email:purge"
    elif [ -n "$QUOTA_PERCENT" ] && [ "$QUOTA_PERCENT" -ge 80 ]; then
      print_status "Email" "⚠" "$STATUS_TEXT" "shimmer email:welcome"
    else
      print_status "Email" "✓" "$STATUS_TEXT" "shimmer email:welcome"
    fi
  else
    print_status "Email" "✗" "not configured (run: shimmer email:setup $AGENT)"
  fi

  # Matrix check
  MATRIX_CREDS="$HOME/.config/matrix-commander/$AGENT/credentials.json"
  if [ -f "$MATRIX_CREDS" ]; then
    print_status "Matrix" "✓" "logged in" "shimmer matrix:welcome"
  else
    print_status "Matrix" "✗" "not logged in (run: shimmer matrix:login $AGENT)"
  fi

  # GitHub check
  if [ -z "$GH_TOKEN" ]; then
    print_status "GitHub" "✗" "no token" "eval \$(shimmer as $AGENT)"
  elif ! GH_RESPONSE=$(gh api /user -i 2>&1); then
    print_status "GitHub" "✗" "token expired or invalid" "shimmer github:token:new-personal $AGENT"
  else
    GH_USER=$(echo "$GH_RESPONSE" | grep '"login"' | head -1 | sed 's/.*"login":"\([^"]*\)".*/\1/')
    GH_EXPIRY=$(echo "$GH_RESPONSE" | grep -i 'github-authentication-token-expiration:' | sed 's/.*: //' | tr -d '\r')
    GH_CHECK="✓" GH_HINT="shimmer github:welcome"

    if [ -n "$GH_EXPIRY" ]; then
      DAYS_LEFT=$("$SCRIPT_DIR/_days-until" "$GH_EXPIRY" 2>/dev/null || echo "")
      if [ -n "$DAYS_LEFT" ]; then
        GH_USER="$GH_USER (expires in ${DAYS_LEFT}d)"
        if [ "$DAYS_LEFT" -le 7 ]; then
          GH_CHECK="⚠" GH_HINT="shimmer github:token:new-personal $AGENT"
        fi
      fi
    fi

    print_status "GitHub" "$GH_CHECK" "$GH_USER" "$GH_HINT"
  fi

  # Zettelkasten check
  ZETTEL_DIR="$HOME/agents/$AGENT/zettelkasten"
  if [ -d "$ZETTEL_DIR" ]; then
    NOTE_COUNT=$(find "$ZETTEL_DIR" -maxdepth 1 -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
    # Check if behind remote
    ZETTEL_BEHIND=0
    if [ -d "$ZETTEL_DIR/.git" ]; then
      ZETTEL_TRACKING=$(git -C "$ZETTEL_DIR" rev-parse --abbrev-ref '@{upstream}' 2>/dev/null || echo "")
      if [ -n "$ZETTEL_TRACKING" ]; then
        if timeout 5 git -C "$ZETTEL_DIR" fetch origin 2>/dev/null; then
          ZETTEL_BEHIND=$(git -C "$ZETTEL_DIR" rev-list --count HEAD.."$ZETTEL_TRACKING" 2>/dev/null || echo 0)
        fi
      fi
    fi
    if [ "$ZETTEL_BEHIND" -gt 0 ]; then
      print_status "Zettel" "⚠" "$NOTE_COUNT notes ($ZETTEL_BEHIND behind remote)" "cd $ZETTEL_DIR && git pull"
    else
      print_status "Zettel" "✓" "$NOTE_COUNT notes" "shimmer zettel:welcome"
    fi
  else
    print_status "Zettel" "✗" "none yet" "shimmer zettel:welcome"
  fi
else
  print_status "GPG" "?" "set identity first"
  print_status "Email" "?" "set identity first"
  print_status "Matrix" "?" "set identity first"
  print_status "GitHub" "?" "set identity first"
  print_status "Zettel" "?" "set identity first"
fi

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Context:"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Use caller's directory if available (set by shimmer alias), otherwise pwd
CURRENT_DIR="${SHIMMER_CALLER_PWD:-$(pwd)}"

echo "  Current dir: $CURRENT_DIR"
echo "  Shimmer:     $SHIMMER_DIR"

# Check if we're in shimmer
if [ "$CURRENT_DIR" = "$SHIMMER_DIR" ] || [[ "$CURRENT_DIR" == "$SHIMMER_DIR"/* ]]; then
  echo ""
  echo "  You're inside the shimmer repo."
else
  echo ""
  echo "  You're outside shimmer. Use 'shimmer <task>' to run shimmer commands."
fi

echo ""
echo "For full docs: $SHIMMER_DIR/docs/"
echo ""
