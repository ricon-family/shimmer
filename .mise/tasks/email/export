#!/usr/bin/env bash
#MISE description="Export emails to a directory"
#USAGE arg "[ids...]" var=#true help="Message IDs to export (or 'all' for entire folder)"
#USAGE flag "-d --destination <path>" help="Directory to export to (default: ./emails)"
#USAGE flag "-f --folder <folder>" help="Folder to export from (default: INBOX)"
#USAGE flag "-n --limit <limit>" help="Limit number of emails when using 'all' (default: 500)"

set -e

# Suppress himalaya debug warnings (still shows errors)
export RUST_LOG=error

DEST="${usage_destination:-./emails}"
FOLDER="${usage_folder:-INBOX}"
LIMIT="${usage_limit:-500}"
IDS=("${usage_ids[@]}")

# Determine current agent from environment or git config
if [ -n "$GIT_AUTHOR_EMAIL" ]; then
  AGENT=$(echo "$GIT_AUTHOR_EMAIL" | sed 's/@ricon\.family$//')
elif git config user.email 2>/dev/null | grep -q '@ricon.family'; then
  AGENT=$(git config user.email | sed 's/@ricon\.family$//')
else
  echo "No agent identity detected. Run: eval \$(shimmer as <agent>)"
  exit 1
fi

CONFIG_FILE="${HOME}/.config/himalaya/config.toml"
if [ ! -f "$CONFIG_FILE" ] || ! grep -q "accounts.$AGENT" "$CONFIG_FILE" 2>/dev/null; then
  echo "Email not configured for $AGENT. Run: shimmer email:setup $AGENT"
  exit 1
fi

# Create destination directory
mkdir -p "$DEST"

# Get message IDs - either from args or fetch all from folder
if [ ${#IDS[@]} -eq 0 ] || [ "${IDS[0]}" = "all" ]; then
  echo "Fetching message list from $FOLDER..."
  # Get IDs from envelope list, skip header rows (3 lines), extract ID column (pipe-delimited)
  IDS=()
  while IFS= read -r id; do
    [ -n "$id" ] && IDS+=("$id")
  done < <(himalaya envelope list -a "$AGENT" -f "$FOLDER" --page-size "$LIMIT" 2>/dev/null | tail -n +4 | awk -F'|' '{gsub(/^[ \t]+|[ \t]+$/, "", $2); print $2}' | grep -E '^[0-9]+$')
fi

if [ ${#IDS[@]} -eq 0 ]; then
  echo "No messages to export"
  exit 0
fi

echo "Exporting ${#IDS[@]} message(s) from $FOLDER to $DEST..."

# Export each message
EXPORTED=0
FAILED=0
for ID in "${IDS[@]}"; do
  if himalaya message read -a "$AGENT" -f "$FOLDER" "$ID" > "$DEST/$ID.eml" 2>/dev/null; then
    ((EXPORTED++))
  else
    echo "  Failed: $ID"
    rm -f "$DEST/$ID.eml"
    ((FAILED++))
  fi
done

echo "Exported $EXPORTED message(s) to $DEST"
if [ $FAILED -gt 0 ]; then
  echo "Failed to export $FAILED message(s)"
fi
