#!/usr/bin/env bash
#MISE description="List email messages"
#USAGE flag "-n --limit <limit>" help="Number of messages to show (default: 10)"
#USAGE flag "-f --folder <folder>" help="Folder to list (default: INBOX)"
#USAGE flag "-p --page <page>" help="Page number, starting from 1 (default: 1)"
#USAGE flag "--unread" help="Only show unread messages"
#USAGE flag "--count" help="Just output the count (useful for scripts)"

set -e

# Suppress himalaya debug warnings (still shows errors)
export RUST_LOG=error

LIMIT="${usage_limit:-10}"
FOLDER="${usage_folder:-INBOX}"
PAGE="${usage_page:-1}"
UNREAD="${usage_unread:-false}"
COUNT_ONLY="${usage_count:-false}"

# Determine current agent from environment or git config
if [ -n "$GIT_AUTHOR_EMAIL" ]; then
  AGENT=$(echo "$GIT_AUTHOR_EMAIL" | sed 's/@ricon\.family$//')
elif git config user.email 2>/dev/null | grep -q '@ricon.family'; then
  AGENT=$(git config user.email | sed 's/@ricon\.family$//')
else
  echo "No agent identity detected. Run: eval \$(shimmer as <agent>)"
  exit 1
fi

CONFIG_FILE="${HOME}/.config/himalaya/config.toml"
if [ ! -f "$CONFIG_FILE" ] || ! grep -q "accounts.$AGENT" "$CONFIG_FILE" 2>/dev/null; then
  echo "Email not configured for $AGENT. Run: shimmer email:setup $AGENT"
  exit 1
fi

# Build query for unread filter
QUERY=""
if [ "$UNREAD" = "true" ]; then
  QUERY="not flag seen"
fi

# List envelopes with account selection
# Fetch one extra to detect if there are more messages beyond the limit
OUTPUT=$(himalaya envelope list -a "$AGENT" -f "$FOLDER" -p "$PAGE" -w 120 --page-size "$((LIMIT + 1))" $QUERY)

# Count data rows (skip 3 header rows: blank + column headers + separator)
DATA_ROWS=$(echo "$OUTPUT" | tail -n +4 | wc -l | tr -d ' ')

if [ "$COUNT_ONLY" = "true" ]; then
  # himalaya has no dedicated count command, so fetch with a large page size
  # TODO: replace with a proper count API if himalaya adds one
  COUNT_OUTPUT=$(himalaya envelope list -a "$AGENT" -f "$FOLDER" -w 120 --page-size 10000 $QUERY)
  echo "$COUNT_OUTPUT" | tail -n +4 | wc -l | tr -d ' '
else
  # Show up to LIMIT rows (plus 3 header rows)
  echo "$OUTPUT" | head -$((LIMIT + 3))
  if [ "$DATA_ROWS" -gt "$LIMIT" ]; then
    echo "(showing $LIMIT, more available â€” use -n or -p to see more)"
  fi
  echo ""
  echo "Flags: * = unread, @ = has attachment"
fi
