#!/usr/bin/env bash
#MISE description="Delete email message(s) (moves to Trash)"
#USAGE arg "<ids>" var=#true help="Message ID(s) to delete"

set -e

# Suppress himalaya debug warnings (still shows errors)
export RUST_LOG=error

IDS=("${usage_ids[@]}")

if [ ${#IDS[@]} -eq 0 ]; then
  echo "Usage: shimmer email:delete <id> [id...]"
  echo ""
  echo "Moves message(s) to Trash. Find IDs with: shimmer email:list"
  exit 1
fi

# Determine current agent from environment or git config
if [ -n "$GIT_AUTHOR_EMAIL" ]; then
  AGENT=$(echo "$GIT_AUTHOR_EMAIL" | sed 's/@ricon\.family$//')
elif git config user.email 2>/dev/null | grep -q '@ricon.family'; then
  AGENT=$(git config user.email | sed 's/@ricon\.family$//')
else
  echo "No agent identity detected. Run: eval \$(shimmer as <agent>)"
  exit 1
fi

CONFIG_FILE="${HOME}/.config/himalaya/config.toml"
if [ ! -f "$CONFIG_FILE" ] || ! grep -q "accounts.$AGENT" "$CONFIG_FILE" 2>/dev/null; then
  echo "Email not configured for $AGENT. Run: shimmer email:setup $AGENT"
  exit 1
fi

himalaya message delete -a "$AGENT" "${IDS[@]}"
echo "Moved ${#IDS[@]} message(s) to Trash"
