#!/usr/bin/env bash
#MISE description="Reply to an email message"
#USAGE arg "<id>" help="Message ID to reply to"
#USAGE arg "[body]" help="Reply body (optional, or use -b flag or stdin)"
#USAGE flag "-b --body <body>" help="Reply body (alternative to positional arg)"
#USAGE flag "--allow-short" help="Allow short reply bodies (under 50 chars)"

set -e

# Suppress himalaya debug warnings (still shows errors)
export RUST_LOG=error

ID="${usage_id:-$1}"
# Body can come from: positional arg, -b flag, or stdin
BODY="${usage_body:-${2:-}}"

if [ -z "$ID" ]; then
  echo "Usage: shimmer email:reply <id> [body]"
  echo ""
  echo "Examples:"
  echo "  shimmer email:reply 42 'Thanks for the info!'"
  echo "  shimmer email:reply 42 --body 'Thanks for the info!'"
  echo "  echo 'Thanks!' | shimmer email:reply 42"
  echo ""
  echo "Find message IDs with: shimmer email:list"
  exit 1
fi

# Determine current agent from environment or git config
if [ -n "$GIT_AUTHOR_EMAIL" ]; then
  AGENT=$(echo "$GIT_AUTHOR_EMAIL" | sed 's/@ricon\.family$//')
elif git config user.email 2>/dev/null | grep -q '@ricon.family'; then
  AGENT=$(git config user.email | sed 's/@ricon\.family$//')
else
  echo "No agent identity detected. Run: eval \$(shimmer as <agent>)"
  exit 1
fi

CONFIG_FILE="${HOME}/.config/himalaya/config.toml"
if [ ! -f "$CONFIG_FILE" ] || ! grep -q "accounts.$AGENT" "$CONFIG_FILE" 2>/dev/null; then
  echo "Email not configured for $AGENT. Run: shimmer email:setup $AGENT"
  exit 1
fi

# If BODY looks like a file path and the file exists, read its contents
if [ -n "$BODY" ] && [ -f "$BODY" ]; then
  BODY=$(cat "$BODY")
fi

# Read body from stdin if not provided via flag
if [ -z "$BODY" ]; then
  if [ -t 0 ]; then
    echo "Enter reply body (Ctrl+D when done):"
  fi
  BODY=$(cat)
fi

if [ -z "$BODY" ]; then
  echo "Error: Reply body is required"
  exit 1
fi

# Guard against suspiciously short messages (wrong args, unresolved paths, etc.)
BODY_LEN=${#BODY}
if [ "$BODY_LEN" -lt 50 ] && [ "${usage_allow_short:-false}" != "true" ]; then
  echo "Error: Reply body seems too short ($BODY_LEN chars)."
  echo "If intentional, re-run with --allow-short"
  exit 1
fi

# Get reply template headers
REPLY_TEMPLATE=$(himalaya template reply -a "$AGENT" "$ID" "")

# Extract just the headers (everything before the first blank line)
HEADERS=$(echo "$REPLY_TEMPLATE" | sed '/^$/q')

# Build the full message with signed body
{
  echo "$HEADERS"
  echo ""  # blank line between headers and body
  echo "<#part sign=pgpmime>"
  echo "$BODY"
  echo "<#/part>"
} | himalaya template send -a "$AGENT"

echo "Reply sent"
