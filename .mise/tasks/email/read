#!/usr/bin/env bash
#MISE description="Read an email message"
#USAGE arg "<id>" help="Message ID to read"
#USAGE flag "-f --folder <folder>" help="Folder to read from (default: INBOX)"

set -e

# Suppress himalaya debug warnings (still shows errors)
export RUST_LOG=error

ID="${usage_id:-$1}"
FOLDER="${usage_folder:-INBOX}"

if [ -z "$ID" ]; then
  echo "Usage: shimmer email:read <id>"
  echo ""
  echo "Find message IDs with: shimmer email:list"
  exit 1
fi

# Determine current agent from environment or git config
if [ -n "$GIT_AUTHOR_EMAIL" ]; then
  AGENT=$(echo "$GIT_AUTHOR_EMAIL" | sed 's/@ricon\.family$//')
elif git config user.email 2>/dev/null | grep -q '@ricon.family'; then
  AGENT=$(git config user.email | sed 's/@ricon\.family$//')
else
  echo "No agent identity detected. Run: eval \$(shimmer as <agent>)"
  exit 1
fi

CONFIG_FILE="${HOME}/.config/himalaya/config.toml"
if [ ! -f "$CONFIG_FILE" ] || ! grep -q "accounts.$AGENT" "$CONFIG_FILE" 2>/dev/null; then
  echo "Email not configured for $AGENT. Run: shimmer email:setup $AGENT"
  exit 1
fi

# Verify GPG signature on the raw message
SIG_TAG=""
TMPDIR=$(mktemp -d)
trap 'rm -rf "$TMPDIR"' EXIT

if himalaya message export --full -a "$AGENT" -f "$FOLDER" -d "$TMPDIR/msg.eml" "$ID" >/dev/null 2>&1; then
  GPG_OUTPUT=$(gpg --verify "$TMPDIR/msg.eml" 2>&1) && GPG_EXIT=0 || GPG_EXIT=$?

  if [ $GPG_EXIT -eq 0 ] && echo "$GPG_OUTPUT" | grep -q "Good signature"; then
    SIGNER=$(echo "$GPG_OUTPUT" | grep "Good signature from" | sed 's/.*Good signature from "\(.*\)".*/\1/')
    SIG_TAG="(✓ Signed by ${SIGNER})"
  elif echo "$GPG_OUTPUT" | grep -q "BAD signature"; then
    SIG_TAG="(✗ Bad signature)"
  elif echo "$GPG_OUTPUT" | grep -q "no valid OpenPGP data"; then
    SIG_TAG="(⚠ Unsigned)"
  elif echo "$GPG_OUTPUT" | grep -q "No public key"; then
    KEY_ID=$(echo "$GPG_OUTPUT" | grep "using .* key" | sed 's/.*key \([A-F0-9]*\).*/\1/' | tail -c 17)
    SIG_TAG="(⚠ Signed, unknown key ${KEY_ID})"
  else
    SIG_TAG="(⚠ Could not verify signature)"
  fi
fi

# Read the message and annotate the From line with signature status
OUTPUT=$(himalaya message read -a "$AGENT" -f "$FOLDER" "$ID")

if [ -n "$SIG_TAG" ]; then
  # Annotate the first From: line with signature status
  FIRST=true
  while IFS= read -r line; do
    if $FIRST && [[ "$line" == From:* ]]; then
      echo "${line} ${SIG_TAG}"
      FIRST=false
    else
      echo "$line"
    fi
  done <<< "$OUTPUT"
else
  echo "$OUTPUT"
fi
