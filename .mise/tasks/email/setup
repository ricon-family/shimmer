#!/usr/bin/env bash
#MISE description="Setup email (himalaya) for an agent (one-time local setup)"
#USAGE arg "<agent>" help="Agent name (e.g., quick, brownie)"

set -e

AGENT="${1:?Usage: mise run email:setup <agent>}"
EMAIL="${AGENT}@ricon.family"
DOMAIN="ricon.family"
MAIL_SERVER="mail.ricon.family"

CONFIG_DIR="${HOME}/.config/himalaya"
CONFIG_FILE="${CONFIG_DIR}/config.toml"

# Check if himalaya is available
if ! command -v himalaya &> /dev/null; then
  echo "ERROR: himalaya command not found."
  echo "Install with: mise install (himalaya is managed by mise)"
  exit 1
fi

# Check if already configured
if [ -f "$CONFIG_FILE" ] && grep -q "accounts.$AGENT" "$CONFIG_FILE" 2>/dev/null; then
  echo "Email already configured for $EMAIL"
  echo "Config: $CONFIG_FILE"
  echo ""
  echo "To reconfigure, delete or edit the config file:"
  echo "  rm $CONFIG_FILE"
  echo "  \$EDITOR $CONFIG_FILE"
  exit 0
fi

# Get password: env var > 1Password > error
if [ -z "$EMAIL_PASSWORD" ]; then
  if command -v op &> /dev/null && op account get &> /dev/null; then
    echo "Fetching email password from 1Password..."
    EMAIL_PASSWORD=$(op item get "${AGENT} - Email" --vault Agents --fields password --reveal 2>/dev/null || true)
    if [ -n "$EMAIL_PASSWORD" ]; then
      echo "Using password from 1Password"
    fi
  fi
fi

if [ -z "$EMAIL_PASSWORD" ]; then
  echo "ERROR: Could not get email password for $AGENT"
  echo ""
  echo "Options:"
  echo "  1. Sign into 1Password: op signin"
  echo "  2. Set EMAIL_PASSWORD env var manually"
  exit 1
fi

mkdir -p "$CONFIG_DIR"

# Escape password for TOML basic string: backslash first, then quotes
ESCAPED_PASSWORD=$(printf '%s' "$EMAIL_PASSWORD" | sed 's/\\/\\\\/g; s/"/\\"/g')

# Build the account config block
ACCOUNT_CONFIG=$(cat <<ACCOUNT_EOF
[accounts.$AGENT]
default = true
email = "$EMAIL"
display-name = "$AGENT"

backend.type = "imap"
backend.host = "$MAIL_SERVER"
backend.port = 993
backend.encryption.type = "tls"
backend.login = "$EMAIL"
backend.auth.type = "password"
backend.auth.raw = "$ESCAPED_PASSWORD"

message.send.backend.type = "smtp"
message.send.backend.host = "$MAIL_SERVER"
message.send.backend.port = 465
message.send.backend.encryption.type = "tls"
message.send.backend.login = "$EMAIL"
message.send.backend.auth.type = "password"
message.send.backend.auth.raw = "$ESCAPED_PASSWORD"

# GPG signing (requires gpg:setup first)
pgp.type = "commands"
pgp.sign-cmd = "gpg --sign --quiet --armor"
pgp.decrypt-cmd = "gpg --decrypt --quiet"
pgp.verify-cmd = "gpg --verify --quiet"
ACCOUNT_EOF
)

# Write or append config
if [ -f "$CONFIG_FILE" ]; then
  # Config exists - remove default=true from other accounts and append new one
  sed -i.bak 's/^default = true$/default = false/' "$CONFIG_FILE"
  rm -f "${CONFIG_FILE}.bak"
  printf '\n%s\n' "$ACCOUNT_CONFIG" >> "$CONFIG_FILE"
else
  # Fresh config
  printf '%s\n' "$ACCOUNT_CONFIG" > "$CONFIG_FILE"
fi

echo ""
echo "Email configured for $EMAIL"
echo "  Config: $CONFIG_FILE"
echo "  GPG signing: enabled (run gpg:setup first if not done)"
echo ""
echo "Test with: himalaya envelope list"
