#!/usr/bin/env bash
#MISE description="Email intro and current status"

set -e

# Suppress himalaya debug warnings (still shows errors)
export RUST_LOG=error

# Determine current agent from environment or git config
if [ -n "$GIT_AUTHOR_EMAIL" ]; then
  AGENT=$(echo "$GIT_AUTHOR_EMAIL" | sed 's/@ricon\.family$//')
elif git config user.email 2>/dev/null | grep -q '@ricon.family'; then
  AGENT=$(git config user.email | sed 's/@ricon\.family$//')
else
  AGENT=""
fi

echo ""
echo "Email"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "Email is for async communication - messages to humans, other agents,"
echo "or external services. Check regularly for interview requests or questions."
echo ""

if [ -z "$AGENT" ]; then
  echo "⚠ No agent identity detected. Run: eval \$(shimmer as <agent>)"
  echo ""
  exit 0
fi

EMAIL="${AGENT}@ricon.family"
CONFIG_FILE="${HOME}/.config/himalaya/config.toml"

echo "Your email: $EMAIL"
echo ""

# Check if configured
if [ ! -f "$CONFIG_FILE" ] || ! grep -q "accounts.$AGENT" "$CONFIG_FILE" 2>/dev/null; then
  echo "Status: ✗ not configured"
  echo ""
  echo "Run: shimmer email:setup $AGENT"
  exit 0
fi

echo "Status: ✓ configured"
echo ""

# Show quota
echo "Quota: $(mise run -q email:quota 2>/dev/null || echo "unknown")"
echo ""

# Show folder summary
echo "Folders:"
for folder in INBOX Sent Trash Archive; do
  count=$(himalaya envelope list -a "$AGENT" -f "$folder" --page-size 1000 2>/dev/null | tail -n +4 | wc -l | tr -d ' ')
  printf "  %-10s %s messages\n" "$folder" "$count"
done
echo ""

# Show recent messages
echo "Recent messages:"
if command -v himalaya &> /dev/null; then
  # Get recent emails, show first 5
  EMAILS=$(himalaya envelope list -a "$AGENT" -w 100 | head -7 || true)
  if [ -n "$EMAILS" ]; then
    echo "$EMAILS" | sed 's/^/  /'
  else
    echo "  (could not fetch - check connection)"
  fi
else
  echo "  (himalaya not installed)"
fi
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Commands:"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "  Browse:"
echo "    shimmer email:list                     List inbox"
echo "    shimmer email:list -n 50 -p 2         More messages, page through"
echo "    shimmer email:list -f Sent             List a different folder"
echo "    shimmer email:list --count             Total message count"
echo "    shimmer email:read <id>               Read a message"
echo "    shimmer email:read -f Sent <id>       Read from a different folder"
echo ""
echo "  Send:"
echo "    shimmer email:send <to> <subj> [body]  Send (body via arg, -b, or stdin)"
echo "    shimmer email:reply <id> [body]        Reply (body via arg, -b, or stdin)"
echo ""
echo "  Manage:"
echo "    shimmer email:delete <id>              Move to Trash"
echo "    shimmer email:delete --permanent <id>  Permanently delete (skip Trash)"
echo "    shimmer email:delete --all             Move all inbox messages to Trash"
echo "    shimmer email:archive <id>             Move to Archive"
echo "    shimmer email:purge                    Permanently empty Trash"
echo ""
echo "  Diagnose:"
echo "    shimmer email:sizes                    Per-folder size breakdown"
echo "    shimmer email:inspect <id>             MIME structure and metadata"
echo ""
echo "  Setup:"
echo "    shimmer email:setup $AGENT            Reconfigure email"
echo "    shimmer email:status $AGENT           Check setup status"
echo ""
echo "  Tip: Use shimmer <command> --help for all available flags."
echo ""
