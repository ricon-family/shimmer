#!/usr/bin/env bash
#MISE description="Permanently delete all messages in a folder"
#USAGE arg "[folder]" help="Folder to purge (default: Trash)"
#USAGE flag "--force" help="Skip confirmation prompt"

set -e

# Suppress himalaya debug warnings (still shows errors)
export RUST_LOG=error

FOLDER="${usage_folder:-Trash}"
FORCE="${usage_force:-false}"

# Determine current agent from environment or git config
if [ -n "$GIT_AUTHOR_EMAIL" ]; then
  AGENT=$(echo "$GIT_AUTHOR_EMAIL" | sed 's/@ricon\.family$//')
elif git config user.email 2>/dev/null | grep -q '@ricon.family'; then
  AGENT=$(git config user.email | sed 's/@ricon\.family$//')
else
  echo "No agent identity detected. Run: eval \$(shimmer as <agent>)"
  exit 1
fi

CONFIG_FILE="${HOME}/.config/himalaya/config.toml"
if [ ! -f "$CONFIG_FILE" ] || ! grep -q "accounts.$AGENT" "$CONFIG_FILE" 2>/dev/null; then
  echo "Email not configured for $AGENT. Run: shimmer email:setup $AGENT"
  exit 1
fi

# Count messages in folder
COUNT=$(himalaya envelope list -a "$AGENT" -f "$FOLDER" --page-size 1000 2>/dev/null | tail -n +4 | wc -l | tr -d ' ')

if [ "$COUNT" -eq 0 ]; then
  echo "$FOLDER is empty"
  exit 0
fi

# Confirm unless --force
if [ "$FORCE" != "true" ]; then
  echo "This will permanently delete $COUNT message(s) from $FOLDER."
  printf "Continue? [y/N] "
  read -r REPLY
  if [[ ! "$REPLY" =~ ^[Yy]$ ]]; then
    echo "Aborted"
    exit 1
  fi
fi

if [ "$FORCE" = "true" ]; then
  himalaya folder purge -a "$AGENT" -y "$FOLDER"
else
  himalaya folder purge -a "$AGENT" "$FOLDER"
fi
echo "Purged $COUNT message(s) from $FOLDER"
