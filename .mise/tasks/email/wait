#!/usr/bin/env bash
#MISE description="Wait for new email to arrive"
#USAGE flag "-f --folder <folder>" help="Folder to watch (default: INBOX)"
#USAGE flag "-n --count <n>" help="Wait for at least N new messages (default: 1)"
#USAGE flag "--timeout <seconds>" help="Max wait time in seconds (default: 600, or 'forever')"
#USAGE flag "--interval <seconds>" help="Poll interval in seconds (default: 30)"
#USAGE arg "[query...]" var=#true help="Optional himalaya query filter (e.g. 'from groups.io')"

set -e

# Suppress himalaya debug warnings (still shows errors)
export RUST_LOG=error

FOLDER="${usage_folder:-INBOX}"
COUNT="${usage_count:-1}"
INTERVAL="${usage_interval:-30}"

# Parse timeout
if [[ "${usage_timeout:-}" == "forever" ]]; then
  TIMEOUT=-1
else
  TIMEOUT="${usage_timeout:-600}"
fi

# Parse optional query (variadic args - mise passes as shell-escaped string)
# Use eval to strip mise's quoting, same pattern as email:delete
QUERY_ARGS=()
if [ -n "${usage_query:-}" ]; then
  eval "QUERY_ARGS=($usage_query)"
fi

# Determine current agent from environment or git config
if [ -n "$GIT_AUTHOR_EMAIL" ]; then
  AGENT=$(echo "$GIT_AUTHOR_EMAIL" | sed 's/@ricon\.family$//')
elif git config user.email 2>/dev/null | grep -q '@ricon.family'; then
  AGENT=$(git config user.email | sed 's/@ricon\.family$//')
else
  echo "No agent identity detected. Run: eval \$(shimmer as <agent>)"
  exit 1
fi

CONFIG_FILE="${HOME}/.config/himalaya/config.toml"
if [ ! -f "$CONFIG_FILE" ] || ! grep -q "accounts.$AGENT" "$CONFIG_FILE" 2>/dev/null; then
  echo "Email not configured for $AGENT. Run: shimmer email:setup $AGENT"
  exit 1
fi

# Fetch current envelope IDs from the folder (optionally filtered by query)
get_ids() {
  himalaya envelope list -a "$AGENT" -f "$FOLDER" --page-size 1000 -o json "${QUERY_ARGS[@]}" 2>/dev/null \
    | jq -r '.[].id'
}

# Debug mode (set DEBUG=1 to enable)
debug() { [ "${DEBUG:-}" = "1" ] && echo "[debug] $*" >&2; }

# Snapshot current state
INITIAL_IDS=$(get_ids | sort)
debug "snapshot: $(echo "$INITIAL_IDS" | tr '\n' ' ')"
debug "agent=$AGENT folder=$FOLDER count=$COUNT interval=$INTERVAL timeout=$TIMEOUT query='${QUERY_ARGS[*]}'"

# Poll loop
ELAPSED=0
while true; do
  sleep "$INTERVAL"
  ELAPSED=$((ELAPSED + INTERVAL))

  CURRENT_IDS=$(get_ids | sort)
  debug "current: $(echo "$CURRENT_IDS" | tr '\n' ' ')"

  # Find new IDs (in current but not in initial)
  NEW_IDS=$(comm -23 <(echo "$CURRENT_IDS") <(echo "$INITIAL_IDS"))
  NEW_COUNT=$(echo "$NEW_IDS" | grep -c . || true)
  debug "new: $(echo "$NEW_IDS" | tr '\n' ' ') count=$NEW_COUNT"

  printf "\rWaiting for mail in %s... %ds (%d new)" "$FOLDER" "$ELAPSED" "$NEW_COUNT" >&2

  if [ "$NEW_COUNT" -ge "$COUNT" ]; then
    echo "" >&2
    echo "$NEW_IDS"
    exit 0
  fi

  if [ "$TIMEOUT" -gt 0 ] && [ "$ELAPSED" -ge "$TIMEOUT" ]; then
    echo "" >&2
    if [ "$NEW_COUNT" -gt 0 ]; then
      echo "Timeout: $NEW_COUNT/$COUNT new" >&2
      echo "$NEW_IDS"
    fi
    exit 0
  fi
done
