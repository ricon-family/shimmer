#!/bin/bash
#MISE description="Generate workflow files from agents.yaml"
#USAGE flag "--check" help="Check mode: fail if generated files differ from committed"
set -eo pipefail

cd "$(git rev-parse --show-toplevel)"

TEMPLATE=".github/templates/agent-job.yml"
OUTPUT_DIR=".github/workflows"
CHECK_MODE="${usage_check:-false}"

# Use temp dir in check mode
if [[ "$CHECK_MODE" == "true" ]]; then
  OUTPUT_DIR=$(mktemp -d)
  trap "rm -rf $OUTPUT_DIR" EXIT
fi

# Read agents and jobs from manifest
AGENTS=$(yq -r '.agents | keys | .[]' agents.yaml)

for AGENT in $AGENTS; do
  JOBS=$(yq -r ".agents.$AGENT.jobs | keys | .[]" agents.yaml)

  for JOB in $JOBS; do
    SCHEDULE=$(yq -r ".agents.$AGENT.jobs.$JOB.schedule" agents.yaml)
    AGENT_UPPER=$(echo "$AGENT" | tr '[:lower:]' '[:upper:]')

    OUTPUT_FILE="$OUTPUT_DIR/${AGENT}-${JOB}.yml"

    export AGENT JOB SCHEDULE AGENT_UPPER
    envsubst < "$TEMPLATE" > "$OUTPUT_FILE"

    echo "Generated: ${AGENT}-${JOB}.yml"
  done
done

# In check mode, diff against committed files
if [[ "$CHECK_MODE" == "true" ]]; then
  DIFF_FOUND=false

  for AGENT in $AGENTS; do
    JOBS=$(yq -r ".agents.$AGENT.jobs | keys | .[]" agents.yaml)
    for JOB in $JOBS; do
      GENERATED="$OUTPUT_DIR/${AGENT}-${JOB}.yml"
      COMMITTED=".github/workflows/${AGENT}-${JOB}.yml"

      if [[ ! -f "$COMMITTED" ]]; then
        echo "Missing: $COMMITTED"
        DIFF_FOUND=true
      elif ! diff -q "$GENERATED" "$COMMITTED" > /dev/null 2>&1; then
        echo "Differs: $COMMITTED"
        diff "$GENERATED" "$COMMITTED" || true
        DIFF_FOUND=true
      fi
    done
  done

  if [[ "$DIFF_FOUND" == "true" ]]; then
    echo ""
    echo "Workflow files are out of sync with agents.yaml"
    echo "Run 'mise run workflows:generate' to regenerate"
    exit 1
  fi

  echo ""
  echo "All workflow files match agents.yaml"
fi
