#!/bin/bash
#MISE description="Generate workflow files from workflows.yaml"
#USAGE flag "--check" help="Check mode: fail if generated files differ from committed"
set -eo pipefail

# Determine target directory (caller's directory when using shimmer alias)
TARGET_DIR="${PROJECT_DIR:-${SHIMMER_CALLER_PWD:-.}}"
cd "$TARGET_DIR"

# Shimmer is always at ~/shimmer (where the global command lives)
SHIMMER_DIR="$HOME/shimmer"

# Use local template if exists, otherwise use shimmer's
if [[ -f ".github/templates/agent-scheduled.yml" ]]; then
  TEMPLATE=".github/templates/agent-scheduled.yml"
else
  TEMPLATE="$SHIMMER_DIR/.github/templates/agent-scheduled.yml"
fi
OUTPUT_DIR=".github/workflows"
CHECK_MODE="${usage_check:-false}"

# Use temp dir in check mode
if [[ "$CHECK_MODE" == "true" ]]; then
  OUTPUT_DIR=$(mktemp -d)
  trap "rm -rf $OUTPUT_DIR" EXIT
fi

# Ensure output directory exists
mkdir -p "$OUTPUT_DIR"

# Copy base workflow templates from shimmer
echo "Copying base templates from shimmer..."
cp "$SHIMMER_DIR/.github/templates/agent-run.yml" "$OUTPUT_DIR/agent-run.yml"
echo "Generated: agent-run.yml"
cp "$SHIMMER_DIR/.github/templates/agent-message.yml" "$OUTPUT_DIR/agent-message.yml"
echo "Generated: agent-message.yml"

# Read workflows from manifest
WORKFLOW_COUNT=$(yq -r '.workflows | length' workflows.yaml 2>/dev/null || echo "0")

# Generate scheduled workflows (if workflows.yaml exists and has workflows)
if [[ "$WORKFLOW_COUNT" -gt 0 ]]; then
  for i in $(seq 0 $((WORKFLOW_COUNT - 1))); do
    NAME=$(yq -r ".workflows[$i].name" workflows.yaml)
    AGENT=$(yq -r ".workflows[$i].agent" workflows.yaml)
    SCHEDULE=$(yq -r ".workflows[$i].schedule" workflows.yaml)
    MESSAGE=$(yq -r ".workflows[$i].message" workflows.yaml)
    MODEL=$(yq -r ".workflows[$i].model // \"\"" workflows.yaml)
    AGENT_UPPER=$(echo "$AGENT" | tr '[:lower:]' '[:upper:]')

    OUTPUT_FILE="$OUTPUT_DIR/${NAME}.yml"

    # Export for envsubst, using temp file for message to handle special chars
    export NAME AGENT SCHEDULE AGENT_UPPER MODEL

    # Use sed to replace MESSAGE separately (envsubst doesn't handle multiline well)
    envsubst '${NAME} ${AGENT} ${SCHEDULE} ${AGENT_UPPER} ${MODEL}' < "$TEMPLATE" | \
      sed "s|\${MESSAGE}|$MESSAGE|g" > "$OUTPUT_FILE"

    # Remove empty model line if no model specified
    if [[ -z "$MODEL" ]]; then
      sed -i '' '/^      model: *$/d' "$OUTPUT_FILE"
    fi

    echo "Generated: ${NAME}.yml"
  done
fi

# In check mode, diff against committed files
if [[ "$CHECK_MODE" == "true" ]]; then
  DIFF_FOUND=false

  # Check base templates
  for BASE in agent-run.yml agent-message.yml; do
    GENERATED="$OUTPUT_DIR/$BASE"
    COMMITTED=".github/workflows/$BASE"

    if [[ ! -f "$COMMITTED" ]]; then
      echo "Missing: $COMMITTED"
      DIFF_FOUND=true
    elif ! diff -q "$GENERATED" "$COMMITTED" > /dev/null 2>&1; then
      echo "Differs: $COMMITTED"
      diff "$GENERATED" "$COMMITTED" || true
      DIFF_FOUND=true
    fi
  done

  # Check scheduled workflows
  if [[ "$WORKFLOW_COUNT" -gt 0 ]]; then
    for i in $(seq 0 $((WORKFLOW_COUNT - 1))); do
      NAME=$(yq -r ".workflows[$i].name" workflows.yaml)
      GENERATED="$OUTPUT_DIR/${NAME}.yml"
      COMMITTED=".github/workflows/${NAME}.yml"

      if [[ ! -f "$COMMITTED" ]]; then
        echo "Missing: $COMMITTED"
        DIFF_FOUND=true
      elif ! diff -q "$GENERATED" "$COMMITTED" > /dev/null 2>&1; then
        echo "Differs: $COMMITTED"
        diff "$GENERATED" "$COMMITTED" || true
        DIFF_FOUND=true
      fi
    done
  fi

  if [[ "$DIFF_FOUND" == "true" ]]; then
    echo ""
    echo "Workflow files are out of sync"
    echo "Run 'shimmer workflows:generate' to regenerate"
    exit 1
  fi

  echo ""
  echo "All workflow files are in sync"
fi
