#!/usr/bin/env bash
#MISE description="Store agent credentials in 1Password Agents vault (idempotent)"
#MISE usage="store-agent-credentials <agent-name> <email-password>"

set -e

AGENT="${1:?Usage: mise run store-agent-credentials <agent-name> <email-password>}"
EMAIL_PASSWORD="${2:?Usage: mise run store-agent-credentials <agent-name> <email-password>}"
EMAIL="${AGENT}@ricon.family"
VAULT="Agents"

echo "=== Storing credentials for $AGENT in 1Password ==="
echo ""

# Check if op is available
if ! command -v op &> /dev/null; then
  echo "ERROR: 1Password CLI (op) not found. Install via: mise use -g 1password-cli"
  exit 1
fi

# Check if signed in
if ! op account get &> /dev/null; then
  echo "ERROR: Not signed in to 1Password. Run: op signin"
  exit 1
fi

# Check if GPG key exists
if ! gpg --list-keys "$EMAIL" &> /dev/null; then
  echo "ERROR: GPG key for $EMAIL not found. Run: mise run provision-agent $AGENT"
  exit 1
fi

# Get GPG details
KEY_ID=$(gpg --list-keys --keyid-format LONG "$EMAIL" | grep "^pub" | awk '{print $2}' | cut -d'/' -f2)
FINGERPRINT=$(gpg --list-keys --keyid-format LONG "$EMAIL" | grep -A1 "^pub" | tail -1 | tr -d ' ')
PRIVATE_KEY=$(gpg --armor --export-secret-keys "$EMAIL" 2>/dev/null)

# Helper to check if item exists
item_exists() {
  op item get "$1" --vault "$VAULT" &> /dev/null
}

# Email item
if item_exists "${AGENT} - Email"; then
  echo "Skipping ${AGENT} - Email (already exists)"
else
  echo "Creating ${AGENT} - Email..."
  op item create \
    --category login \
    --title "${AGENT} - Email" \
    --vault "$VAULT" \
    --url "https://mail.ricon.family" \
    username="$AGENT" \
    password="$EMAIL_PASSWORD" > /dev/null
  echo "Created ${AGENT} - Email"
fi

# GPG item
if item_exists "${AGENT} - GPG"; then
  echo "Skipping ${AGENT} - GPG (already exists)"
else
  echo "Creating ${AGENT} - GPG..."
  op item create \
    --category "Secure Note" \
    --title "${AGENT} - GPG" \
    --vault "$VAULT" \
    "Key ID[text]=$KEY_ID" \
    "Fingerprint[text]=$FINGERPRINT" \
    "Email[text]=$EMAIL" \
    "Private Key[text]=$PRIVATE_KEY" > /dev/null
  echo "Created ${AGENT} - GPG"
fi

# GitHub item
if item_exists "${AGENT} - GitHub"; then
  echo "Skipping ${AGENT} - GitHub (already exists)"
else
  echo "Creating ${AGENT} - GitHub..."
  op item create \
    --category login \
    --title "${AGENT} - GitHub" \
    --vault "$VAULT" \
    --url "https://github.com" \
    username="${AGENT}-ricon" \
    "email[text]=$EMAIL" \
    "country[text]=United States of America" \
    --generate-password=20,letters,digits > /dev/null
  echo "Created ${AGENT} - GitHub"
fi

echo ""
echo "=== Done ==="
