#!/usr/bin/env bash
#MISE description="Open browser to regenerate an existing personal token for an agent"
#USAGE arg "<agent>" help="Agent name (e.g., c0da, brownie)"

set -e

AGENT="${usage_agent:?Usage: shimmer github:token:regenerate <agent>}"
VAULT="Agents"
ITEM="${AGENT} - GitHub"

# Check 1Password CLI
if ! command -v op &> /dev/null; then
  echo "ERROR: 1Password CLI (op) not found." >&2
  exit 1
fi

if ! op account get &> /dev/null; then
  echo "ERROR: Not signed in to 1Password. Run: op signin" >&2
  exit 1
fi

# Fetch credentials from 1Password
USERNAME=$(op item get "$ITEM" --vault "$VAULT" --fields username 2>/dev/null || true)
PASSWORD=$(op item get "$ITEM" --vault "$VAULT" --fields password --reveal 2>/dev/null || true)

if [ -z "$USERNAME" ] || [ -z "$PASSWORD" ]; then
  echo "ERROR: Could not fetch credentials from 1Password item '$ITEM'" >&2
  exit 1
fi

# Go to the tokens list page â€” find the token named after the agent and click regenerate
TOKEN_PATH="/settings/tokens"
ENCODED_PATH=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$TOKEN_PATH', safe=''))")

LOGIN_URL="https://github.com/login?return_to=${ENCODED_PATH}"

echo "=== Regenerate Token for: $AGENT ==="
echo ""
echo "Credentials:"
echo "  Username: $USERNAME"
echo "  Password: $PASSWORD"
echo ""
echo "If GitHub requests device verification, check the agent's email:"
echo "  shimmer email:list -n 3"
echo "  shimmer email:read <id>"
echo ""
echo "After logging in, find the token named '$AGENT' and click 'Regenerate'."
echo ""
echo "After regenerating:"
echo "  1. Copy the new token value"
echo "  2. shimmer github:token:store $AGENT <token>"
echo "  3. shimmer agent:sync-secrets"
echo ""

# Open incognito browser (macOS)
if [ -d "/Applications/Google Chrome.app" ]; then
  open -na "Google Chrome" --args --incognito "$LOGIN_URL"
elif [ -d "/Applications/Firefox.app" ]; then
  open -na "Firefox" --args -private-window "$LOGIN_URL"
else
  echo "Open this URL in an incognito/private window:"
  echo "$LOGIN_URL"
fi
