#!/usr/bin/env bash
#MISE description="Wait for PR checks to complete (timeout 3 min)"

set -e

PR_NUMBER="${1:-$(gh pr view --json number -q .number 2>/dev/null)}"

if [ -z "$PR_NUMBER" ]; then
  echo "No PR number provided and not on a PR branch"
  exit 1
fi

echo "Waiting for checks on PR #$PR_NUMBER (timeout 3 min)..."
if timeout 180 gh pr checks "$PR_NUMBER" --watch; then
  echo "All checks passed!"
else
  EXIT_CODE=$?
  if [ $EXIT_CODE -eq 124 ]; then
    echo "Timed out waiting for checks"
  else
    echo "Checks failed (exit code: $EXIT_CODE)"
  fi
  exit 1
fi
