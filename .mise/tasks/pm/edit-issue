#!/bin/bash
#MISE description="Edit project fields for an issue"
#USAGE arg "<issue>" help="Issue number"
#USAGE flag "--status <status>" help="Status: Backlog, Ready, In Progress, In Review, Done"
#USAGE flag "--priority <priority>" help="Priority: High, Medium, Low"
set -eo pipefail

# Get arguments from mise usage parser
ISSUE_NUM="${usage_issue:-$1}"
STATUS="${usage_status:-}"
PRIORITY="${usage_priority:-}"

if [[ -z "$ISSUE_NUM" ]]; then
  echo "Usage: mise run pm:edit-issue <issue> [--status STATUS] [--priority PRIORITY]"
  echo ""
  echo "Status options: Backlog, Ready, \"In Progress\", \"In Review\", Done"
  echo "Priority options: High, Medium, Low"
  exit 1
fi

# Determine target directory and repo
TARGET_DIR="${PROJECT_DIR:-${SHIMMER_CALLER_PWD:-.}}"
SCRIPT_DIR="$(dirname "$0")"
REPO=$("$SCRIPT_DIR/_get-repo" "$TARGET_DIR")
OWNER="${REPO%/*}"
PROJECT_NAME="${REPO#*/}"

# Find project by name
PROJECT_JSON=$(gh project list --owner "$OWNER" --format json | jq -r --arg name "$PROJECT_NAME" '.projects[] | select(.title == $name)')
if [[ -z "$PROJECT_JSON" ]]; then
  echo "Error: Could not find project for $REPO"
  exit 1
fi

PROJECT_ID=$(echo "$PROJECT_JSON" | jq -r '.id')
PROJECT_NUM=$(echo "$PROJECT_JSON" | jq -r '.number')

# Get field info
FIELDS_JSON=$(gh project field-list "$PROJECT_NUM" --owner "$OWNER" --format json)

get_field_id() {
  echo "$FIELDS_JSON" | jq -r --arg name "$1" '.fields[] | select(.name == $name) | .id'
}

get_option_id() {
  local field_name="$1"
  local option_name="$2"
  echo "$FIELDS_JSON" | jq -r --arg field "$field_name" --arg opt "$option_name" \
    '.fields[] | select(.name == $field) | .options[]? | select(.name == $opt) | .id'
}

# Get issue URL
ISSUE_URL="https://github.com/${REPO}/issues/${ISSUE_NUM}"

# Check if item is already in project, add if not
ITEM_ID=$(gh project item-list "$PROJECT_NUM" --owner "$OWNER" --format json --limit 100 | \
  jq -r --arg num "$ISSUE_NUM" '.items[] | select(.content.number == ($num | tonumber)) | .id')

if [[ -z "$ITEM_ID" ]]; then
  echo "Adding issue #${ISSUE_NUM} to project..."
  gh project item-add "$PROJECT_NUM" --owner "$OWNER" --url "$ISSUE_URL"

  # Retry loop to find the item (GitHub can be slow to propagate)
  for i in {1..5}; do
    sleep 1
    ITEM_ID=$(gh project item-list "$PROJECT_NUM" --owner "$OWNER" --format json --limit 100 | \
      jq -r --arg num "$ISSUE_NUM" '.items[] | select(.content.number == ($num | tonumber)) | .id')
    if [[ -n "$ITEM_ID" ]]; then
      break
    fi
  done
fi

if [[ -z "$ITEM_ID" ]]; then
  echo "Error: Could not find or add issue #${ISSUE_NUM} to project"
  exit 1
fi

echo "Issue #${ISSUE_NUM} (item: ${ITEM_ID:0:12}...)"

# Set Status if provided
if [[ -n "$STATUS" ]]; then
  FIELD_ID=$(get_field_id "Status")
  OPTION_ID=$(get_option_id "Status" "$STATUS")
  if [[ -z "$OPTION_ID" ]]; then
    echo "Error: Invalid status '$STATUS'"
    echo "Options: Backlog, Ready, \"In Progress\", \"In Review\", Done"
    exit 1
  fi
  gh project item-edit \
    --project-id "$PROJECT_ID" \
    --id "$ITEM_ID" \
    --field-id "$FIELD_ID" \
    --single-select-option-id "$OPTION_ID"
  echo "  Status: $STATUS"
fi

# Set Priority if provided
if [[ -n "$PRIORITY" ]]; then
  FIELD_ID=$(get_field_id "Priority")
  OPTION_ID=$(get_option_id "Priority" "$PRIORITY")
  if [[ -z "$OPTION_ID" ]]; then
    echo "Error: Invalid priority '$PRIORITY'"
    echo "Options: High, Medium, Low"
    exit 1
  fi
  gh project item-edit \
    --project-id "$PROJECT_ID" \
    --id "$ITEM_ID" \
    --field-id "$FIELD_ID" \
    --single-select-option-id "$OPTION_ID"
  echo "  Priority: $PRIORITY"
fi

if [[ -z "$STATUS" && -z "$PRIORITY" ]]; then
  echo "  (no fields updated - use --status or --priority)"
fi
