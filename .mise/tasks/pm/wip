#!/bin/bash
#MISE description="Show work in progress (open PRs and issues with discussion status)"
#USAGE arg "[limit]" help="Maximum items to show (default: 20)"
set -eo pipefail

export GH_PAGER=""

# Determine target directory and repo
TARGET_DIR="${PROJECT_DIR:-${SHIMMER_CALLER_PWD:-.}}"
SCRIPT_DIR="$(dirname "$0")"
REPO=$("$SCRIPT_DIR/_get-repo" "$TARGET_DIR")
OWNER="${REPO%/*}"
NAME="${REPO#*/}"

# Use limit argument with default
LIMIT="${usage_limit:-20}"

echo "=== Open Issues ==="
gh api graphql -f query="
query {
  repository(owner: \"$OWNER\", name: \"$NAME\") {
    issues(first: $LIMIT, states: OPEN, orderBy: {field: CREATED_AT, direction: ASC}) {
      nodes {
        number
        title
        comments(last: 1) {
          totalCount
          nodes {
            author { login }
            createdAt
          }
        }
      }
    }
  }
}" --jq '.data.repository.issues.nodes[] |
  "#\(.number)  \(.title[0:35])\(if (.title | length) > 35 then "..." else "" end)  \(.comments.totalCount) comments\(
    if .comments.totalCount > 0 then
      " (last: \(.comments.nodes[0].author.login), \(
        (now - (.comments.nodes[0].createdAt | fromdateiso8601)) / 3600 | floor
      )h ago)"
    else "" end
  )"'

echo ""
echo "=== Open PRs ==="
gh api graphql -f query="
query {
  repository(owner: \"$OWNER\", name: \"$NAME\") {
    pullRequests(first: $LIMIT, states: OPEN, orderBy: {field: CREATED_AT, direction: ASC}) {
      nodes {
        number
        title
        comments(last: 1) {
          totalCount
          nodes {
            author { login }
            createdAt
          }
        }
      }
    }
  }
}" --jq '.data.repository.pullRequests.nodes[] |
  "#\(.number)  \(.title[0:35])\(if (.title | length) > 35 then "..." else "" end)  \(.comments.totalCount) comments\(
    if .comments.totalCount > 0 then
      " (last: \(.comments.nodes[0].author.login), \(
        (now - (.comments.nodes[0].createdAt | fromdateiso8601)) / 3600 | floor
      )h ago)"
    else "" end
  )"'
