#!/bin/bash
#MISE description="Set options for a single select field (Status, Priority, etc.)"
#USAGE arg "<field_name>" help="Name of the field (e.g., Status, Priority)"
#USAGE arg "<options>" help="Comma-separated options (e.g., 'Backlog,Ready,Done')"
#USAGE arg "[colors]" help="Comma-separated colors (GRAY,RED,ORANGE,YELLOW,GREEN,BLUE,PURPLE,PINK)"
set -eo pipefail

FIELD_NAME="${usage_field_name:-$1}"
OPTIONS="${usage_options:-$2}"
COLORS="${usage_colors:-$3}"

if [[ -z "$FIELD_NAME" ]] || [[ -z "$OPTIONS" ]]; then
  echo "Usage: mise run pm:field-options <field_name> <options> [colors]"
  echo ""
  echo "Examples:"
  echo "  mise run pm:field-options Status 'Backlog,Ready,In Progress,Done'"
  echo "  mise run pm:field-options Priority 'High,Medium,Low' 'RED,YELLOW,GREEN'"
  echo ""
  echo "Standard Status setup:"
  echo "  mise run pm:field-options Status 'Backlog,Ready,In Progress,In Review,Done' 'GRAY,GREEN,YELLOW,PURPLE,BLUE'"
  exit 1
fi

# Determine target directory and repo
TARGET_DIR="${PROJECT_DIR:-${SHIMMER_CALLER_PWD:-.}}"
SCRIPT_DIR="$(dirname "$0")"
REPO=$("$SCRIPT_DIR/_get-repo" "$TARGET_DIR")

OWNER=$(echo "$REPO" | cut -d'/' -f1)
PROJECT_NAME=$(echo "$REPO" | cut -d'/' -f2)

# Get project number (auto-detect from repo name)
PROJECT_NUM=""
if [[ -z "$PROJECT_NUM" ]]; then
  PROJECT_NUM=$(gh project list --owner "$OWNER" --format json | jq -r --arg name "$PROJECT_NAME" '.projects[] | select(.title == $name) | .number')
fi

if [[ -z "$PROJECT_NUM" ]]; then
  echo "Error: Could not find project for $REPO"
  exit 1
fi

# Check if field exists
FIELD_ID=$(gh project field-list "$PROJECT_NUM" --owner "$OWNER" --format json | jq -r --arg name "$FIELD_NAME" '.fields[] | select(.name == $name) | .id')

# Parse options into array for display
IFS=',' read -ra OPT_ARRAY <<< "$OPTIONS"

if [[ -z "$FIELD_ID" ]]; then
  # Field doesn't exist - create it
  echo "Creating field '$FIELD_NAME' in project #$PROJECT_NUM ($PROJECT_NAME)"
  echo ""

  gh project field-create "$PROJECT_NUM" --owner "$OWNER" \
    --name "$FIELD_NAME" \
    --data-type SINGLE_SELECT \
    --single-select-options "$OPTIONS" > /dev/null

  echo "Field '$FIELD_NAME' created with options:"
  for opt in "${OPT_ARRAY[@]}"; do
    echo "  - $opt"
  done

  # If colors were specified, we need to update via GraphQL since field-create doesn't support colors
  if [[ -n "$COLORS" ]]; then
    echo ""
    echo "Applying colors..."
    # Get the newly created field ID
    FIELD_ID=$(gh project field-list "$PROJECT_NUM" --owner "$OWNER" --format json | jq -r --arg name "$FIELD_NAME" '.fields[] | select(.name == $name) | .id')
  else
    exit 0
  fi
fi

echo "Updating field '$FIELD_NAME' in project #$PROJECT_NUM ($PROJECT_NAME)"
echo "  Field ID: $FIELD_ID"
echo ""

# Parse colors
if [[ -n "$COLORS" ]]; then
  IFS=',' read -ra COLOR_ARRAY <<< "$COLORS"
else
  # Default all to GRAY
  COLOR_ARRAY=()
  for _ in "${OPT_ARRAY[@]}"; do
    COLOR_ARRAY+=("GRAY")
  done
fi

# Build GraphQL options array
OPTIONS_JSON="["
for i in "${!OPT_ARRAY[@]}"; do
  OPT_NAME="${OPT_ARRAY[$i]}"
  OPT_COLOR="${COLOR_ARRAY[$i]:-GRAY}"
  if [[ $i -gt 0 ]]; then
    OPTIONS_JSON+=","
  fi
  OPTIONS_JSON+="{name: \"$OPT_NAME\", color: $OPT_COLOR, description: \"\"}"
done
OPTIONS_JSON+="]"

# Execute mutation
gh api graphql -f query="
mutation {
  updateProjectV2Field(input: {
    fieldId: \"$FIELD_ID\"
    singleSelectOptions: $OPTIONS_JSON
  }) {
    projectV2Field {
      ... on ProjectV2SingleSelectField {
        name
        options {
          name
        }
      }
    }
  }
}" > /dev/null

echo "Field '$FIELD_NAME' updated with options:"
for opt in "${OPT_ARRAY[@]}"; do
  echo "  - $opt"
done
