#!/usr/bin/env bash
#MISE description="Onboarding step 2: Check email for verification code"
#MISE usage="onboard-agent-step2 <agent-name>"

set -e

AGENT="${1:?Usage: mise run onboard-agent-step2 <agent-name>}"
EMAIL="${AGENT}@ricon.family"
VAULT="Agents"

EMAIL_PASSWORD=$(op item get "${AGENT} - Email" --vault "$VAULT" --fields password --reveal 2>/dev/null || echo "")

echo ""
echo "STEP 2: Email Verification"
echo "------------------------------------------------------------"
echo "Checking $EMAIL for verification code..."
echo ""

EMAIL_PASSWORD="$EMAIL_PASSWORD" ./scripts/setup-email.sh "$AGENT" > /dev/null 2>&1
sleep 1

himalaya envelope list 2>/dev/null | head -5

echo ""
echo "To read a message: himalaya message read <ID>"
echo ""
echo "When verified, run: mise run onboard-agent-step3 $AGENT"
