#!/bin/bash
#MISE description="List issues available to work on"
#USAGE flag "--unassigned" help="Only show unassigned issues"
set -eo pipefail

# Determine target directory and repo
TARGET_DIR="${PROJECT_DIR:-${SHIMMER_CALLER_PWD:-.}}"
SCRIPT_DIR="$(dirname "$0")"
REPO=$("$SCRIPT_DIR/../pm/_get-repo" "$TARGET_DIR")
OWNER="${REPO%/*}"
PROJECT_NAME="${REPO#*/}"

# Find project by name
PROJECT_NUM=$(gh project list --owner "$OWNER" --format json | jq -r --arg name "$PROJECT_NAME" '.projects[] | select(.title == $name) | .number')
if [[ -z "$PROJECT_NUM" ]]; then
  echo "Error: Could not find project for $REPO"
  exit 1
fi

# Get flag from mise usage parser
UNASSIGNED_ONLY="${usage_unassigned:-false}"

# Get items with Status = Ready
ITEMS=$(gh project item-list "$PROJECT_NUM" --owner "$OWNER" --format json --limit 100 | \
  jq -r '.items[] | select(.status == "Ready")')

if [[ -z "$ITEMS" ]]; then
  echo "No items with Status: Ready"
  exit 0
fi

# Filter by unassigned if requested
if [[ "$UNASSIGNED_ONLY" == "true" ]]; then
  ITEMS=$(echo "$ITEMS" | jq -s '[.[] | select(.assignees == null or .assignees == [])]')
  echo "Ready items (unassigned only) - $REPO:"
else
  ITEMS=$(echo "$ITEMS" | jq -s '.')
  echo "Ready items - $REPO:"
fi

echo ""

# Display items
echo "$ITEMS" | jq -r '.[] | "#\(.content.number)\t\(.priority // "â€”")\t\(.title)"' | \
  column -t -s $'\t' | \
  while read line; do echo "  $line"; done

COUNT=$(echo "$ITEMS" | jq 'length')
echo ""
echo "Total: $COUNT"
