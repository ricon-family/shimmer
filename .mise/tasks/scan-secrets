#!/usr/bin/env bash
#MISE description="Scan git history for potential secrets before open-sourcing"

# Scans all commits in git history for patterns that may indicate secrets.
# Run this before making a repository public.
#
# Patterns checked:
# - API keys (sk-, ghp_, gho_, github_pat_, xox*-, AKIA, eyJ)
# - Private keys (RSA, Ed25519, DSA)
# - Secret keywords in assignments (password, secret, token, api_key)
# - AWS credentials
# - Base64-encoded JWT tokens

set -eo pipefail

echo "=== Secret Scanner ==="
echo "Scanning git history for potential secrets..."
echo ""

FOUND=0

# Temporary file for git log output
TMPFILE=$(mktemp)
trap "rm -f $TMPFILE" EXIT

# Get full git history with diffs
git log --all --full-history -p > "$TMPFILE"

# Function to scan for pattern
scan_pattern() {
  local name="$1"
  local pattern="$2"

  local matches
  matches=$(grep -nE "$pattern" "$TMPFILE" 2>/dev/null | head -20 || true)

  if [ -n "$matches" ]; then
    echo "[$name]"
    echo "$matches"
    echo ""
    FOUND=$((FOUND + 1))
    return 1
  fi
  return 0
}

echo "Checking API key patterns..."
scan_pattern "GitHub PAT" "ghp_[A-Za-z0-9]{36}" || true
scan_pattern "GitHub OAuth" "gho_[A-Za-z0-9]+" || true
scan_pattern "GitHub PAT v2" "github_pat_[A-Za-z0-9_]+" || true
scan_pattern "Slack Token" "xox[baprs]-[A-Za-z0-9-]+" || true
scan_pattern "AWS Access Key" "AKIA[A-Z0-9]{16}" || true
scan_pattern "OpenAI/Anthropic Key" "sk-[A-Za-z0-9]{32,}" || true

echo "Checking private key patterns..."
scan_pattern "Private Key Header" "BEGIN.*PRIVATE KEY" || true
scan_pattern "SSH RSA Key" "ssh-rsa AAAA[A-Za-z0-9+/]+" || true
scan_pattern "SSH Ed25519 Key" "ssh-ed25519 AAAA[A-Za-z0-9+/]+" || true

echo "Checking for hardcoded secrets in assignments..."
# Look for lines that add (+ prefix) variables with suspicious names
grep -nE '^\+.*=.*' "$TMPFILE" | grep -iE '(password|secret|api_key|apikey|private_key).*=' | head -20 || true

echo ""
echo "=== Scan Complete ==="

if [ "$FOUND" -gt 0 ]; then
  echo "Found $FOUND categories with potential secrets."
  echo "Review the output above and decide if any are actual secrets."
  echo "False positives are common - check each finding manually."
  exit 1
else
  echo "No obvious secret patterns found."
  echo "Consider also using dedicated tools like gitleaks or truffleHog for deeper analysis."
fi
