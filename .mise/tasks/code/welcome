#!/usr/bin/env bash
#MISE description="Show information about the current codebase"

set -e

# Use caller's directory if available, otherwise pwd
CURRENT_DIR="${SHIMMER_CALLER_PWD:-$(pwd)}"

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Current Codebase"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "  Directory: $CURRENT_DIR"

# Check if it's a git repo
if git -C "$CURRENT_DIR" rev-parse --git-dir &>/dev/null; then
  REPO_ROOT=$(git -C "$CURRENT_DIR" rev-parse --show-toplevel)
  BRANCH=$(git -C "$CURRENT_DIR" branch --show-current 2>/dev/null || echo "(detached)")

  # Get remote URL if available
  REMOTE_URL=$(git -C "$CURRENT_DIR" remote get-url origin 2>/dev/null || echo "")
  if [ -n "$REMOTE_URL" ]; then
    # Extract repo name from URL
    REPO_NAME=$(echo "$REMOTE_URL" | sed 's/.*[:/]\([^/]*\/[^/]*\)\.git$/\1/' | sed 's/.*[:/]\([^/]*\/[^/]*\)$/\1/')
    echo "  Repository: $REPO_NAME"
  fi

  echo "  Branch: $BRANCH"

  # Check for CLAUDE.md
  if [ -f "$REPO_ROOT/CLAUDE.md" ]; then
    echo "  CLAUDE.md: present"
  else
    echo "  CLAUDE.md: missing"
  fi

  echo ""
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo "Recent Activity"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ""

  # Recent commits
  echo "  Recent commits:"
  git -C "$CURRENT_DIR" log --oneline -5 2>/dev/null | sed 's/^/    /'

  # Open PRs (if gh is available and authenticated)
  if [ -n "$REMOTE_URL" ] && command -v gh &>/dev/null; then
    echo ""
    echo "  Open PRs:"
    PR_COUNT=$(gh pr list --repo "$REPO_NAME" --limit 5 --json number,title --jq 'length' 2>/dev/null || echo "0")
    if [ "$PR_COUNT" -gt 0 ]; then
      gh pr list --repo "$REPO_NAME" --limit 5 --json number,title --jq '.[] | "    #\(.number) \(.title)"' 2>/dev/null || echo "    (couldn't fetch)"
    else
      echo "    (none)"
    fi
  fi
else
  echo ""
  echo "  Not a git repository."
fi

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "To start a new project: shimmer code:init:welcome"
echo ""
