#!/usr/bin/env bash
#MISE description="Initialize a new codebase with standard structure"
#MISE alias="code:init"
set -eo pipefail

# Find shimmer directory (for template)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SHIMMER_DIR="$(cd "$SCRIPT_DIR/../../../.." && pwd)"
TEMPLATE_FILE="$SHIMMER_DIR/templates/CLAUDE.md"

# Known orgs
ORGS=("ricon-family" "KnickKnackLabs")

# Parse arguments
REPO_ARG=""
COMMAND_ARG=""
PATH_ARG=""
DESC_ARG=""

while [[ $# -gt 0 ]]; do
  case $1 in
    --command)
      COMMAND_ARG="$2"
      shift 2
      ;;
    --path)
      PATH_ARG="$2"
      shift 2
      ;;
    --description)
      DESC_ARG="$2"
      shift 2
      ;;
    -*)
      echo "Unknown option: $1" >&2
      exit 1
      ;;
    *)
      if [[ -z "$REPO_ARG" ]]; then
        REPO_ARG="$1"
      else
        echo "Unexpected argument: $1" >&2
        exit 1
      fi
      shift
      ;;
  esac
done

# Show usage if no repo
if [[ -z "$REPO_ARG" ]]; then
  echo "Usage: shimmer code:init <org>/<name> [--command <cmd>] [--path <path>] [--description <desc>]" >&2
  echo "" >&2
  echo "Initialize a new codebase with standard structure." >&2
  echo "" >&2
  echo "Arguments:" >&2
  echo "  <org>/<name>   GitHub repo identifier (e.g., ricon-family/monkeys)" >&2
  echo "" >&2
  echo "Options:" >&2
  echo "  --command      CLI command name (default: repo name)" >&2
  echo "  --path         Install path (default: ~/<name>)" >&2
  echo "  --description  One-line project description" >&2
  echo "" >&2
  echo "Examples:" >&2
  echo "  shimmer code:init ricon-family/monkeys --description \"A tool for monkey business\"" >&2
  echo "  shimmer code:init ricon-family/zettelkasten --command zettel" >&2
  exit 1
fi

# Parse org/name from repo arg
if [[ "$REPO_ARG" == */* ]]; then
  ORG_ARG="${REPO_ARG%%/*}"
  NAME_ARG="${REPO_ARG#*/}"
else
  echo "Error: Invalid repo format. Expected <org>/<name>, got: $REPO_ARG" >&2
  exit 1
fi

# Validate org
VALID_ORG=false
for org in "${ORGS[@]}"; do
  if [[ "$org" == "$ORG_ARG" ]]; then
    VALID_ORG=true
    break
  fi
done

if [[ "$VALID_ORG" != "true" ]]; then
  echo "Error: Unknown org '$ORG_ARG'. Known orgs: ${ORGS[*]}" >&2
  exit 1
fi

# Command defaults to name
if [[ -z "$COMMAND_ARG" ]]; then
  COMMAND_ARG="$NAME_ARG"
fi

# Path defaults to ~/<name>
if [[ -z "$PATH_ARG" ]]; then
  PATH_ARG="$HOME/$NAME_ARG"
else
  # Resolve path
  if [[ "$PATH_ARG" == /* ]] || [[ "$PATH_ARG" == ~* ]]; then
    PATH_ARG="${PATH_ARG/#\~/$HOME}"
  else
    CALLER_DIR="${SHIMMER_CALLER_PWD:-.}"
    PATH_ARG="$CALLER_DIR/$PATH_ARG"
  fi
fi

# Check if directory already exists
if [[ -d "$PATH_ARG" ]]; then
  echo "Error: Directory already exists: $PATH_ARG" >&2
  exit 1
fi

# Interactive mode: prompt for description if not provided
if [[ -z "$DESC_ARG" ]]; then
  if [[ -t 0 ]] && [[ -t 1 ]]; then
    DESC_ARG=$(gum input --placeholder "One-line description..." --header "Project description:")
  else
    DESC_ARG="A new project"
  fi
fi

echo ""
echo "Initializing codebase:"
echo "  Repo:        $ORG_ARG/$NAME_ARG"
echo "  Command:     $COMMAND_ARG"
echo "  Path:        $PATH_ARG"
echo "  Description: $DESC_ARG"
echo ""

# Create directory structure
mkdir -p "$PATH_ARG/.mise/tasks"

# Initialize git
git -C "$PATH_ARG" init --quiet

# Write CLAUDE.md
if [[ -f "$TEMPLATE_FILE" ]]; then
  export PROJECT_NAME="$NAME_ARG"
  export PROJECT_DESCRIPTION="$DESC_ARG"
  envsubst '${PROJECT_NAME} ${PROJECT_DESCRIPTION}' < "$TEMPLATE_FILE" > "$PATH_ARG/CLAUDE.md"
else
  cat > "$PATH_ARG/CLAUDE.md" << EOF
# $NAME_ARG

$DESC_ARG

## Shimmer

This project uses [shimmer](https://github.com/ricon-family/shimmer) for agent workflows.

Run \`$COMMAND_ARG welcome\` to get started.
EOF
fi
echo "  Created: CLAUDE.md"

# Write README.md
cat > "$PATH_ARG/README.md" << EOF
# $NAME_ARG

$DESC_ARG

## Install

\`\`\`bash
git clone https://github.com/$ORG_ARG/$NAME_ARG.git ~/$NAME_ARG
cd ~/$NAME_ARG && mise trust && mise install

# Add to your shell config (~/.zshrc or ~/.bashrc)
eval "\$(mise -C ~/$NAME_ARG run -q shell)"

# Reload and verify
source ~/.zshrc
$COMMAND_ARG welcome
\`\`\`

## Usage

\`\`\`bash
$COMMAND_ARG          # Show available commands
$COMMAND_ARG welcome  # Verify setup
\`\`\`

## Development

This project uses [shimmer](https://github.com/ricon-family/shimmer) for agent workflows.
EOF
echo "  Created: README.md"

# Write mise.toml
cat > "$PATH_ARG/mise.toml" << EOF
[tools]
# Add your dependencies here
# node = "22"
# python = "3.12"
EOF
echo "  Created: mise.toml"

# Write shell task
cat > "$PATH_ARG/.mise/tasks/shell" << EOF
#!/usr/bin/env bash
#MISE description="Output shell configuration for global $COMMAND_ARG command (use with eval)"
REPO_DIR="\$(cd "\$(dirname "\${BASH_SOURCE[0]}")/../.." && pwd)"
echo "alias $COMMAND_ARG='SHIMMER_CALLER_PWD=\"\\\$PWD\" mise -C \"\$REPO_DIR\" run'"
EOF
chmod +x "$PATH_ARG/.mise/tasks/shell"
echo "  Created: .mise/tasks/shell"

# Write welcome task
cat > "$PATH_ARG/.mise/tasks/welcome" << EOF
#!/usr/bin/env bash
#MISE description="Welcome message and setup verification"

SCRIPT_DIR="\$(cd "\$(dirname "\${BASH_SOURCE[0]}")" && pwd)"
REPO_DIR="\$(cd "\$SCRIPT_DIR/../.." && pwd)"

echo ""
echo "Welcome to $NAME_ARG!"
echo ""
echo "$DESC_ARG"
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Commands:"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "  $COMMAND_ARG welcome    This message"
echo "  $COMMAND_ARG tasks      List all available tasks"
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "Location: \$REPO_DIR"
echo ""
EOF
chmod +x "$PATH_ARG/.mise/tasks/welcome"
echo "  Created: .mise/tasks/welcome"

# Write .gitignore
cat > "$PATH_ARG/.gitignore" << EOF
# mise
.mise.local.toml

# OS
.DS_Store
EOF
echo "  Created: .gitignore"

# Initial commit
git -C "$PATH_ARG" add -A
git -C "$PATH_ARG" commit --quiet -m "Initial commit

Initialized with shimmer code:init"

echo ""
echo "Done! Codebase initialized at: $PATH_ARG"
echo ""
echo "Next steps:"
echo "  cd $PATH_ARG"
echo "  mise trust && mise install"
echo "  eval \"\$(mise run -q shell)\""
echo "  $COMMAND_ARG welcome"
echo ""
