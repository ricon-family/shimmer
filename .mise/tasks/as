#!/usr/bin/env bash
#MISE description="Switch to an agent's identity for local work"
#USAGE arg "[agent]" help="Agent to switch to (omit for interactive picker)"

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Find agents directory
AGENTS_DIR=$("$SCRIPT_DIR/_get-agents-dir") || exit 1

# Discover agents from the agents directory
get_agents() {
  ls "$AGENTS_DIR"/*.txt 2>/dev/null \
    | xargs -n1 basename \
    | sed 's/\.txt$//' \
    | sort
}

AGENT="$usage_agent"

# Interactive picker when no agent specified
if [ -z "$AGENT" ]; then
  if ! command -v fzf &> /dev/null; then
    echo "ERROR: fzf not found. Either specify an agent or install fzf." >&2
    exit 1
  fi

  AGENT=$(get_agents | fzf \
    --style=full \
    --height=100% \
    --layout=reverse \
    --border=rounded \
    --border-label=" shimmer as " \
    --border-label-pos=3 \
    --preview-label=" Activity " \
    --pointer="â–¸" \
    --prompt="  " \
    --ghost="Type to filter..." \
    --margin=5% \
    --padding=1,2 \
    --color="
      bg:-1,bg+:#2a2d3d
      border:dim,preview-border:dim
      label:bold,preview-label:bold
      pointer:bright-cyan
      gutter:-1
      info:dim
    " \
    --preview="$SCRIPT_DIR/_agent-preview {} '$AGENTS_DIR'" \
    --preview-window="right,55%,border-rounded,wrap,<60(down,50%,border-horizontal)" \
  ) || exit 1

  if [ -z "$AGENT" ]; then
    echo "No agent selected." >&2
    exit 1
  fi
fi

EMAIL="${AGENT}@ricon.family"
VAULT="Agents"

# Validate agent
if ! get_agents | grep -qx "$AGENT"; then
  echo "Unknown agent: $AGENT" >&2
  echo "Available agents: $(get_agents | tr '\n' ' ')" >&2
  echo "Agents directory: $AGENTS_DIR" >&2
  exit 1
fi

# Check 1Password CLI
if ! command -v op &> /dev/null; then
  echo "ERROR: 1Password CLI (op) not found." >&2
  exit 1
fi

if ! op account get &> /dev/null; then
  echo "ERROR: Not signed in to 1Password. Run: op signin" >&2
  exit 1
fi

# Fetch GitHub PAT from 1Password
ITEM="${AGENT} - GitHub"
PAT=$(op item get "$ITEM" --vault "$VAULT" --fields PAT --reveal 2>/dev/null || true)

if [ -z "$PAT" ]; then
  echo "ERROR: Could not find PAT in 1Password item '$ITEM'" >&2
  echo "Make sure the agent has been fully onboarded with mise run agent:onboard $AGENT" >&2
  exit 1
fi

# Output export statements for eval
echo "export GH_TOKEN='$PAT'"
echo "export GIT_AUTHOR_EMAIL='$EMAIL'"
echo "export GIT_COMMITTER_EMAIL='$EMAIL'"
echo "export GIT_AUTHOR_NAME='$AGENT'"
echo "export GIT_COMMITTER_NAME='$AGENT'"
echo "export AGENT_HOME='$(dirname "$AGENTS_DIR")'"

# Print info to stderr so it doesn't interfere with eval
echo "# Agent identity set: $AGENT ($EMAIL)" >&2
echo "# Verify with: shimmer whoami" >&2
