#!/usr/bin/env bash
#MISE description="Switch to an agent's identity for local work"
#MISE usage="as <agent>"

set -e

# Discover agents from prompt files (source of truth for agents)
get_agents() {
  ls cli/priv/prompts/agents/*.txt 2>/dev/null \
    | xargs -n1 basename \
    | sed 's/\.txt$//' \
    | sort
}

if [ $# -lt 1 ]; then
  echo "Usage: mise run as <agent>"
  echo ""
  echo "Sets up environment for working as an agent locally."
  echo "Requires 1Password CLI (op) to be signed in."
  echo ""
  echo "Agents: $(get_agents | tr '\n' ' ')"
  echo ""
  echo "Example: eval \$(mise run as quick)"
  exit 1
fi

AGENT="$1"
EMAIL="${AGENT}@ricon.family"
VAULT="Agents"

# Validate agent
if ! get_agents | grep -qx "$AGENT"; then
  echo "Unknown agent: $AGENT" >&2
  echo "Available agents: $(get_agents | tr '\n' ' ')" >&2
  exit 1
fi

# Check 1Password CLI
if ! command -v op &> /dev/null; then
  echo "ERROR: 1Password CLI (op) not found." >&2
  exit 1
fi

if ! op account get &> /dev/null; then
  echo "ERROR: Not signed in to 1Password. Run: op signin" >&2
  exit 1
fi

# Fetch GitHub PAT from 1Password
ITEM="${AGENT} - GitHub"
PAT=$(op item get "$ITEM" --vault "$VAULT" --fields PAT 2>/dev/null || true)

if [ -z "$PAT" ]; then
  echo "ERROR: Could not find PAT in 1Password item '$ITEM'" >&2
  echo "Make sure the agent has been fully onboarded with mise run onboard-agent $AGENT" >&2
  exit 1
fi

# Output export statements for eval
echo "export GH_TOKEN='$PAT'"
echo "export GIT_AUTHOR_EMAIL='$EMAIL'"
echo "export GIT_COMMITTER_EMAIL='$EMAIL'"
echo "export GIT_AUTHOR_NAME='$AGENT'"
echo "export GIT_COMMITTER_NAME='$AGENT'"

# Print info to stderr so it doesn't interfere with eval
echo "# Agent identity set: $AGENT ($EMAIL)" >&2
echo "# To apply: eval \$(mise run as $AGENT)" >&2
