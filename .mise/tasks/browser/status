#!/usr/bin/env bash
#MISE description="Show browser auth status for current agent"

set -e

# Determine agent identity
if [ -n "$GIT_AUTHOR_EMAIL" ]; then
  AGENT=$(echo "$GIT_AUTHOR_EMAIL" | sed 's/@ricon\.family$//')
elif git config user.email 2>/dev/null | grep -q '@ricon.family'; then
  AGENT=$(git config user.email | sed 's/@ricon\.family$//')
else
  AGENT=""
fi

echo ""
echo "Browser Automation"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Check Playwright installation
CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/shimmer/browser"
if [ -d "$CACHE_DIR" ] && ls "$CACHE_DIR"/chromium-* &>/dev/null 2>&1; then
  echo "  Chromium: installed"
else
  echo "  Chromium: not installed (run: shimmer browser:setup)"
fi
echo ""

if [ -z "$AGENT" ]; then
  echo "  No agent identity detected."
  echo "  Run: eval \$(shimmer as <agent>)"
  exit 0
fi

# Check auth files
AUTH_DIR="$HOME/.config/shimmer/browser/$AGENT"
if [ -d "$AUTH_DIR" ] && ls "$AUTH_DIR"/*.json &>/dev/null 2>&1; then
  echo "  Auth for $AGENT:"
  for f in "$AUTH_DIR"/*.json; do
    SITE=$(basename "$f" .json)
    AGE_MINS=$(( ($(date +%s) - $(stat -f %m "$f" 2>/dev/null || stat -c %Y "$f" 2>/dev/null)) / 60 ))
    if [ "$AGE_MINS" -gt 1440 ]; then
      echo "    $SITE  (${AGE_MINS}m old, may be expired)"
    else
      echo "    $SITE  (${AGE_MINS}m old)"
    fi
  done
else
  echo "  No auth saved for $AGENT"
fi

echo ""

# List built-in scripts
TASK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPTS=$(ls "$TASK_DIR/scripts/"*.mjs 2>/dev/null | grep -v '_harness' || true)
if [ -n "$SCRIPTS" ]; then
  echo "  Scripts:"
  echo "$SCRIPTS" | xargs -n1 basename | sed 's/\.mjs$//' | sed 's/^/    /'
  echo ""
fi

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "  shimmer browser:setup              Install Chromium"
echo "  shimmer browser:login <site>       Log in interactively"
echo "  shimmer browser:run <script> ...   Run automation script"
echo ""
