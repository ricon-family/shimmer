#!/usr/bin/env bash
#MISE description="Interactive browser login to save auth for a site"
#USAGE arg "<site>" help="Site to authenticate with (e.g. github.com)"

set -e

SITE="${usage_site:?Usage: shimmer browser:login <site>}"

# Determine agent identity
if [ -n "$GIT_AUTHOR_EMAIL" ]; then
  AGENT=$(echo "$GIT_AUTHOR_EMAIL" | sed 's/@ricon\.family$//')
elif git config user.email 2>/dev/null | grep -q '@ricon.family'; then
  AGENT=$(git config user.email | sed 's/@ricon\.family$//')
else
  echo "No agent identity detected. Run: eval \$(shimmer as <agent>)" >&2
  exit 1
fi

# Auth state directory
AUTH_DIR="$HOME/.config/shimmer/browser/$AGENT"
AUTH_FILE="$AUTH_DIR/${SITE}.json"
mkdir -p "$AUTH_DIR"

# Browser cache
CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/shimmer/browser"
export PLAYWRIGHT_BROWSERS_PATH="$CACHE_DIR"

if [ ! -d "$CACHE_DIR" ] || ! ls "$CACHE_DIR"/chromium-* &>/dev/null; then
  echo "Chromium not installed. Run: shimmer browser:setup" >&2
  exit 1
fi

if [ -f "$AUTH_FILE" ]; then
  echo "Existing auth found for $AGENT @ $SITE"
  echo "  $AUTH_FILE"
  echo "Will be overwritten on browser close."
  echo ""
fi

echo "Opening browser for $AGENT to log in to $SITE..."
echo "Log in manually, then close the browser window."
echo ""

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

node "$SCRIPT_DIR/scripts/_harness.mjs" \
  --mode login \
  --site "$SITE" \
  --auth-file "$AUTH_FILE"

if [ -f "$AUTH_FILE" ]; then
  echo ""
  echo "Auth saved for $AGENT @ $SITE"
  echo "  $AUTH_FILE"
else
  echo ""
  echo "No auth state was saved." >&2
  exit 1
fi
