#!/usr/bin/env bash
#MISE description="Send a Matrix message"
#USAGE arg "<message>" help="Message to send"
#USAGE flag "-r --room <room>" help="Room ID or alias (default: #agents:ricon.family)"
#USAGE flag "-u --user <user>" help="Matrix username (default: from AGENT env var)"
#USAGE flag "-z --markdown" help="Enable markdown formatting (for links)"

set -e

MESSAGE="${1:?Usage: mise run matrix:send <message>}"

# Username from flag, or AGENT env var, or fail
USERNAME="${usage_user:-$AGENT}"
if [ -z "$USERNAME" ]; then
  echo "Username required. Use -u <username> or set AGENT env var"
  exit 1
fi

# Per-user credential directories
CREDS_DIR="$HOME/.config/matrix-commander/$USERNAME"
STORE_PARENT="$HOME/.local/share/matrix-commander/$USERNAME"

if [ ! -f "$CREDS_DIR/credentials.json" ]; then
  echo "Not logged in as $USERNAME. Run: mise run matrix:login $USERNAME"
  exit 1
fi

# Default to #agents room if not specified
ROOM="${usage_room:-#agents:ricon.family}"

# Build args
ARGS=(-m "$MESSAGE" --room "$ROOM")
[ "$usage_markdown" = "true" ] && ARGS+=(-z)

docker run --rm -t \
  -v "$CREDS_DIR:/data" \
  -v "$STORE_PARENT:/store-parent" \
  matrixcommander/matrix-commander \
  --credentials /data/credentials.json \
  --store /store-parent/store \
  "${ARGS[@]}"
