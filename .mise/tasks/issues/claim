#!/bin/bash
#MISE description="Claim an issue to work on"
#USAGE arg "<issue>" help="Issue number to claim"
set -eo pipefail

# Static IDs
PROJECT_ID="PVT_kwDODumhvM4BMSWk"
PROJECT_NUM="4"
OWNER="ricon-family"
REPO="ricon-family/shimmer"
STATUS_FIELD="PVTSSF_lADODumhvM4BMSWkzg7nRgc"
IN_PROGRESS_OPTION="cc214903"

# Get argument from mise usage parser
ISSUE_NUM="${usage_issue:-$1}"

if [[ -z "$ISSUE_NUM" ]]; then
  echo "Usage: mise run issues:claim <issue>"
  exit 1
fi

# Get item ID
ITEM_ID=$(gh project item-list "$PROJECT_NUM" --owner "$OWNER" --format json --limit 100 | \
  jq -r --arg num "$ISSUE_NUM" '.items[] | select(.content.number == ($num | tonumber)) | .id')

if [[ -z "$ITEM_ID" ]]; then
  echo "Error: Issue #${ISSUE_NUM} not found in project"
  echo "This issue isn't Ready yet. Ask PM to triage it first."
  exit 1
fi

# Set Status to In Progress
gh project item-edit \
  --project-id "$PROJECT_ID" \
  --id "$ITEM_ID" \
  --field-id "$STATUS_FIELD" \
  --single-select-option-id "$IN_PROGRESS_OPTION"

# Assign to self (use gh issue edit, not project API)
gh issue edit "$ISSUE_NUM" --repo "$REPO" --add-assignee "@me"

echo "Claimed issue #${ISSUE_NUM}"
echo "  Status: In Progress"
echo "  Assigned to: @me"
