#!/usr/bin/env bash
#MISE description="Provision a new agent identity (GPG key, sign with org, store secrets)"
#MISE usage="provision-agent <agent-name> [--force]"

set -e

AGENT="${1:?Usage: mise run provision-agent <agent-name> [--force]}"
FORCE="${2:-}"
EMAIL="${AGENT}@ricon.family"
UPPER=$(echo "$AGENT" | tr '[:lower:]' '[:upper:]')

echo "=== Provisioning agent: $AGENT ==="
echo ""

# Check if org key exists
if ! gpg --list-keys admin@ricon.family >/dev/null 2>&1; then
  echo "ERROR: Org key (admin@ricon.family) not found in keyring."
  echo "Import it first or run this on a machine with the org key."
  exit 1
fi

# Check if agent key already exists
if gpg --list-keys "$EMAIL" >/dev/null 2>&1; then
  echo "GPG key for $EMAIL already exists."
  if [ "$FORCE" != "--force" ]; then
    echo "Use --force to sign and update secrets anyway."
    exit 0
  fi
  echo "Continuing with --force..."
else
  echo "Generating GPG key for $EMAIL..."
  gpg --batch --gen-key << KEYSPEC
Key-Type: RSA
Key-Length: 4096
Name-Real: $AGENT
Name-Email: $EMAIL
Expire-Date: 0
%no-protection
%commit
KEYSPEC
  echo "Key generated."
fi

# Sign with org key
echo ""
echo "Signing $EMAIL with org key..."
FINGERPRINT=$(gpg --list-keys --keyid-format LONG "$EMAIL" | grep -A1 "^pub" | tail -1 | tr -d ' ')
gpg --batch --yes --no-tty --local-user admin@ricon.family --quick-sign-key "$FINGERPRINT" 2>&1 || true
echo "Key signed."

# Verify signature
echo ""
echo "Verifying signatures on $EMAIL:"
gpg --list-sigs "$EMAIL" | grep -E "(sig|uid)"

# Store secrets
echo ""
echo "Storing secrets..."
gpg --armor --export-secret-keys "$EMAIL" | gh secret set "${UPPER}_GPG_PRIVATE_KEY"
gpg --armor --export "$EMAIL" | gh secret set "${UPPER}_GPG_PUBLIC_KEY"
echo "Secrets stored: ${UPPER}_GPG_PRIVATE_KEY, ${UPPER}_GPG_PUBLIC_KEY"

echo ""
echo "=== $AGENT provisioned ==="
echo ""
echo "Next steps:"
echo "  1. Create GitHub account for $AGENT using $EMAIL"
echo "  2. Upload GPG public key to GitHub account"
echo "  3. Generate PAT and run: gh secret set ${UPPER}_GITHUB_PAT"
echo "  4. Verify email password secret exists: ${UPPER}_EMAIL_PASSWORD"
