#!/usr/bin/env bash
#MISE description="Watch the latest workflow run until completion"
#MISE usage="watch <agent> <job>"

set -e

# Discover agents from prompt files (source of truth for agents)
get_agents() {
  ls cli/priv/prompts/agents/*.txt 2>/dev/null \
    | xargs -n1 basename \
    | sed 's/\.txt$//' \
    | sort
}

# Discover jobs for a specific agent
get_jobs() {
  local agent="$1"
  ls .github/workflows/${agent}-*.yml 2>/dev/null \
    | xargs -n1 basename \
    | sed "s/^${agent}-//; s/\.yml$//" \
    | sort
}

if [ $# -lt 2 ]; then
  echo "Usage: mise run watch <agent> <job>"
  echo ""
  echo "Agents: $(get_agents | tr '\n' ' ')"
  echo ""
  echo "Jobs for each agent:"
  for agent in $(get_agents); do
    jobs=$(get_jobs "$agent" | tr '\n' ' ')
    echo "  $agent: $jobs"
  done
  echo ""
  echo "Example: mise run watch quick probe"
  exit 1
fi

AGENT="$1"
JOB="$2"
WORKFLOW="${AGENT}-${JOB}.yml"

# Validate agent
if ! get_agents | grep -qx "$AGENT"; then
  echo "Unknown agent: $AGENT"
  echo "Available agents: $(get_agents | tr '\n' ' ')"
  exit 1
fi

# Validate workflow exists
if [ ! -f ".github/workflows/$WORKFLOW" ]; then
  echo "Workflow not found: $WORKFLOW"
  echo ""
  echo "Available workflows for $AGENT:"
  ls .github/workflows/${AGENT}-*.yml 2>/dev/null | xargs -n1 basename | sed 's/^/  /' || echo "  (none)"
  exit 1
fi

RUN_ID=$(gh run list --workflow="$WORKFLOW" --limit 1 --json databaseId -q '.[0].databaseId')

if [ -z "$RUN_ID" ]; then
  echo "No runs found for workflow: $WORKFLOW"
  exit 1
fi

gh run watch "$RUN_ID"
