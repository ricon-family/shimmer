#!/usr/bin/env bash
#MISE description="Setup agent GitHub account (invite to org, check email for verification)"
#MISE usage="setup-agent-github <agent-name>"

set -e

AGENT="${1:?Usage: mise run setup-agent-github <agent-name>}"
AGENT_UPPER=$(echo "$AGENT" | tr '[:lower:]' '[:upper:]')
EMAIL="${AGENT}@ricon.family"
GITHUB_USERNAME="${AGENT}-ricon"

echo "=== Setting up GitHub for $AGENT ==="
echo ""

# Check org membership
echo "Checking org membership for $GITHUB_USERNAME..."
MEMBERSHIP=$(gh api "orgs/ricon-family/memberships/$GITHUB_USERNAME" 2>&1 || true)

if echo "$MEMBERSHIP" | grep -q '"state":"active"'; then
  echo "$GITHUB_USERNAME is already an active member of ricon-family"

  # Ensure write access to shimmer repo
  echo "Ensuring write access to shimmer repo..."
  gh api --method PUT "repos/ricon-family/shimmer/collaborators/$GITHUB_USERNAME" -f permission=write > /dev/null 2>&1 || true
elif echo "$MEMBERSHIP" | grep -q '"state":"pending"'; then
  echo "$GITHUB_USERNAME has a pending invitation"
  echo ""
  echo "Check their email to accept:"
  echo "  EMAIL_PASSWORD=<password> ./scripts/setup-email.sh $AGENT"
  echo "  himalaya envelope list"
  echo "  himalaya message read <id>"
elif echo "$MEMBERSHIP" | grep -q "Not Found"; then
  echo "Inviting $GITHUB_USERNAME to ricon-family org..."
  gh api --method PUT "orgs/ricon-family/memberships/$GITHUB_USERNAME" -f role=member > /dev/null
  echo "Invitation sent!"

  # Grant write access to shimmer repo
  echo "Granting write access to shimmer repo..."
  gh api --method PUT "repos/ricon-family/shimmer/collaborators/$GITHUB_USERNAME" -f permission=write > /dev/null 2>&1 || true
  echo ""
  echo "Check their email to accept:"
  echo "  EMAIL_PASSWORD=<password> ./scripts/setup-email.sh $AGENT"
  echo "  himalaya envelope list"
  echo "  himalaya message read <id>"
else
  echo "ERROR: Unexpected response from GitHub API"
  echo "$MEMBERSHIP"
  exit 1
fi

echo ""
echo "=== Next steps ==="
echo ""
echo "1. Accept org invitation (if pending)"
echo "2. Upload GPG public key to GitHub:"
echo "   - Copy from 1Password: $AGENT - GPG → Public Key"
echo "   - Go to: https://github.com/settings/keys → New GPG key"
echo "   - Title: $EMAIL"
echo ""
echo "3. Generate PAT:"
echo "   - Go to: https://github.com/settings/tokens?type=beta"
echo "   - Token name: shimmer-agent"
echo "   - Resource owner: ricon-family"
echo "   - Repository access: ricon-family/shimmer"
echo "   - Permissions: Contents (R/W), Workflows (R/W)"
echo ""
echo "4. Store PAT:"
echo "   op item edit \"$AGENT - GitHub\" --vault Agents \"PAT[password]=<token>\""
echo "   gh secret set ${AGENT_UPPER}_GITHUB_PAT"
