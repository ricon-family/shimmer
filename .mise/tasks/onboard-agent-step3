#!/usr/bin/env bash
#MISE description="Onboarding step 3: Org invite + GPG key upload"
#MISE usage="onboard-agent-step3 <agent-name>"

set -e

AGENT="${1:?Usage: mise run onboard-agent-step3 <agent-name>}"
EMAIL="${AGENT}@ricon.family"
GITHUB_USERNAME="${AGENT}-ricon"
VAULT="Agents"

echo ""
echo "STEP 3: Organization Setup"
echo "------------------------------------------------------------"

# Invite to org
MEMBERSHIP=$(gh api "orgs/ricon-family/memberships/$GITHUB_USERNAME" 2>&1 || true)

if echo "$MEMBERSHIP" | grep -q '"state":"active"'; then
  echo "$GITHUB_USERNAME is already an active org member"
else
  echo "Inviting $GITHUB_USERNAME to ricon-family org..."
  gh api --method PUT "orgs/ricon-family/memberships/$GITHUB_USERNAME" -f role=member > /dev/null 2>&1 || true
  echo "Invitation sent! Check email and accept at:"
  echo "  https://github.com/orgs/ricon-family/invitation?via_email=1"
fi

# Grant repo access
echo "Granting write access to shimmer repo..."
gh api --method PUT "repos/ricon-family/shimmer/collaborators/$GITHUB_USERNAME" -f permission=write > /dev/null 2>&1 || true
echo "Done!"

echo ""
echo "STEP 4: Upload GPG Key"
echo "------------------------------------------------------------"
echo "Go to: https://github.com/settings/keys"
echo "Click: New GPG key"
echo "Title: $EMAIL"
echo ""
echo "Public key:"
echo "------------------------------------------------------------"
op item get "${AGENT} - GPG" --vault "$VAULT" --fields "Public Key" 2>/dev/null
echo "------------------------------------------------------------"
echo ""
echo "When done, run: mise run onboard-agent-step4 $AGENT"
