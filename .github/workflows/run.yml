name: Run

on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes
  workflow_dispatch:
    inputs:
      message:
        description: 'Message'
        required: false
        type: string

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "probe-1"
          git config user.email "probe-1@shimmer.local"

      - name: Set up mise
        uses: jdx/mise-action@v2
        with:
          install: true

      - name: Cache Elixir build
        uses: actions/cache@v4
        with:
          path: |
            cli/_build
            cli/deps
          key: ${{ runner.os }}-elixir-${{ hashFiles('cli/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-elixir-

      - name: Build CLI
        run: |
          cd cli
          mix local.hex --force
          mix deps.get
          mix escript.build

      - name: Determine message
        id: message
        run: |
          if [ "${{ github.event_name }}" = "schedule" ] || [ -z "${{ github.event.inputs.message }}" ]; then
            echo "msg=Your name is probe-1. This is your codebase. You are responsible for maintaining it, improving it, and evolving it over time. Each run, pick something to work on: fix something broken, improve code quality, add a small feature, write a test, improve documentation, refactor for clarity, or explore and understand how things work. Be curious. Take initiative. Make it better. If you need tools or capabilities you don't have, note them in REQUESTS.md. If you wish to change your name, note that there too and we will make it happen. Keep changes focused and incremental. IMPORTANT: You must commit and push your changes yourself using git. Changes that are not committed and pushed will be lost." >> $GITHUB_OUTPUT
          else
            echo "msg=${{ github.event.inputs.message }}" >> $GITHUB_OUTPUT
          fi

      - name: Run CLI
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: ./cli/cli "${{ steps.message.outputs.msg }}"

